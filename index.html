<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEVEL UP - Sponsor Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@latest/dist/dotlottie-wc.js" type="module"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #121212; color-scheme: dark; }
        .font-oswald { font-family: 'Oswald', sans-serif; }
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: start; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; transform: scale(1); opacity: 1; overflow-y: auto; padding: 1rem; }
        .screen.hidden { opacity: 0; transform: scale(1.05); pointer-events: none; }
        .auth-view { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; padding: 1rem; transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out; opacity: 0; transform: scale(0.95); pointer-events: none; }
        .auth-view.active { opacity: 1; transform: scale(1); pointer-events: auto; }
        #modal-screen, #forgot-password-modal, #id-pass-modal, #sponsor-live-view-screen, #participant-list-screen, #edit-points-modal, #ban-team-modal, #payment-screen, #loading-overlay, #badge-editor-modal { z-index: 100; background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); }
        .modal-box { background-color: #1e1e1e; border: 1px solid #2a2a2a; box-shadow: 0 10px 30px rgba(0,0,0,0.4); max-width: 420px; width: 90%; }
        .input-field { background-color: #121212; box-shadow: inset 6px 6px 12px #0c0c0c, inset -6px -6px 12px #1a1a1a; transition: box-shadow 0.2s ease; }
        .input-field:focus-within, .form-input:focus { box-shadow: inset 6px 6px 12px #0c0c0c, inset -6px -6px 12px #1a1a1a, 0 0 0 2px #1DB954 !important; outline: none; }
        .action-button, .manage-btn { background-image: linear-gradient(to right, #1DB954, #1ed760); color: white; font-weight: bold; box-shadow: 8px 8px 16px #0d0d0d, -8px -8px 16px #252525; transition: all 0.2s ease-in-out; border: none; }
        .action-button:hover:not(:disabled), .manage-btn:hover { box-shadow: 10px 10px 20px #0d0d0d, -10px -10px 20px #252525; transform: translateY(-2px); }
        .action-button:active:not(:disabled), .manage-btn:active { box-shadow: inset 6px 6px 12px #158a3f, inset -6px -6px 12px #27e869; transform: translateY(1px); }
        .action-button:disabled { background: #555; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }
        main { background: #121212; padding-bottom: 90px !important; }
        .spinner { border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #ffffff; width: 18px; height: 18px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .password-toggle { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); cursor: pointer; color: #9ca3af; }
        #splash-screen-logo, #splash-screen-lottie { position: absolute; transition: opacity 0.6s ease-in-out, transform 0.6s ease-in-out; }
        #splash-screen-lottie.fade-out { opacity: 0; transform: scale(0.8); }
        #splash-screen-logo { opacity: 0; transform: scale(0.8); }
        #splash-screen-logo.fade-in { opacity: 1; transform: scale(1); }
        .nav-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 500px; z-index: 50; }
        .nav-bar { position: relative; display: flex; justify-content: space-around; align-items: center; background-color: #212124; padding: 8px; border-radius: 9999px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); }
        .nav-item { display: flex; align-items: center; justify-content: center; padding: 12px 16px; cursor: pointer; color: #a1a1aa; position: relative; z-index: 10; transition: color 0.3s ease-out; border-radius: 9999px; }
        .nav-item .nav-icon { font-size: 20px; transition: color 0.3s ease-out; }
        .nav-item .nav-label { font-weight: 600; font-size: 14px; white-space: nowrap; margin-left: 0; max-width: 0; opacity: 0; overflow: hidden; transition: max-width 0.3s ease-out, opacity 0.2s 0.1s ease-out, margin-left 0.3s ease-out; }
        .nav-item.active { color: #212124; }
        .nav-item.active .nav-label { max-width: 100px; opacity: 1; margin-left: 10px; }
        #nav-indicator { position: absolute; top: 8px; height: calc(100% - 16px); background-color: #ffffff; border-radius: 9999px; z-index: 5; transition: all 0.35s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .form-section { background: #1e1e1e; border: 1px solid #2a2a2a; }
        .form-label { color: #a1a1aa; font-size: 0.8rem; margin-bottom: 0.5rem; font-weight: 600; }
        .form-input, .form-select, .form-textarea { background: #121212; border: 1px solid #333; color: white; padding: 0.75rem; border-radius: 0.5rem; width: 100%; transition: border-color 0.2s; }
        .map-checkbox label { background: #2a2a2a; border: 1px solid #333; transition: all 0.2s; }
        .map-checkbox input:checked + label { background: #1DB954; color: white; border-color: #1DB954; }
        .prize-input-container { max-height: 0; opacity: 0; overflow: hidden; transition: all 0.3s ease-in-out; margin-top: 0; }
        .dashboard-page { transition: opacity 0.3s ease-in-out; }
        .tab-button { flex: 1; text-align: center; padding: 0.75rem 0; background-color: #2a2a2a; color: #a1a1aa; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .tab-button.active-tab { background-color: #1DB954; color: white; }
        .tab-content-section { display: none; }
        .tab-content-section.active-section { display: block; }
        #image-lightbox { z-index: 200; background-color: rgba(0,0,0,0.85); backdrop-filter: blur(8px); transition: opacity 0.3s ease; }
        #lightbox-img { max-width: 90vw; max-height: 80vh; object-fit: contain; }
        .icon-3d { font-size: 1.2rem; text-shadow: 1px 1px 0px rgba(0,0,0,0.4), -1px -1px 0px rgba(255,255,255,0.1); }
        .icon-tick { color: #22c55e; } .icon-cross { color: #ef4444; }
        #page-transition-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 999; opacity: 0; pointer-events: none; transition: opacity 0.2s ease-in-out; backdrop-filter: blur(5px); }
        #page-transition-overlay.active { opacity: 1; pointer-events: auto; }
        .mail-item { position: relative; } /* MODIFIED: Added for delete button positioning */
        .mail-item.unread { background-color: #2a2a2a; border-left-color: #1DB954; }
        .notification-badge { position: absolute; top: -5px; right: -5px; background-color: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .manage-post-card { background-color: #1e1e1e; border: 1px solid #2a2a2a; }
        .status-tag { padding: 4px 10px; border-radius: 9999px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        @keyframes pulse-live { 0% { box-shadow: 0 0 0 0 rgba(29, 185, 84, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(29, 185, 84, 0); } 100% { box-shadow: 0 0 0 0 rgba(29, 185, 84, 0); } }
        .status-tag.live { background-color: #1DB954; color: white; animation: pulse-live 2s infinite; }
        .status-tag.upcoming { background-color: #3b82f6; color: white; }
        .status-tag.completed { background-color: #6b7280; color: white; }
        .status-tag.cancelled { background-color: #ef4444; color: white; }
        .kyc-upload-box { border: 2px dashed #4a4a4a; transition: all 0.2s; }
        .kyc-upload-box:hover { border-color: #1DB954; background-color: #2a2a2a; }
        .verification-badge { width: 1.2em; height: 1.2em; margin-left: 0.4em; vertical-align: middle; }
        .event-type-card { background-color: #2a2a2a; border: 2px solid #333; transition: all 0.2s ease-in-out; }
        input[name="event-type"]:checked + .event-type-card { border-color: #1DB954; background-color: #1e1e1e; transform: scale(1.05); }
        .event-type-card.disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
        .statement-card { background: #1e1e1e; border-left: 4px solid; } /* MODIFIED: Removed specific color */
        .premium-header { background: rgba(30, 30, 30, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0 0 24px 24px; }
        .header-back-btn { background-color: rgba(255, 255, 255, 0.1); }
        #profile-content { background: radial-gradient(circle, #1e1e1e 0%, #121212 100%); }
        .setting-item { background-color: #2a2a2a; border-radius: 0.75rem; padding: 1.1rem 1rem; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: background-color 0.2s, transform 0.2s; border: 1px solid #3a3a3a; width: 100%; }
        .setting-item:hover { background-color: #3a3a3a; transform: scale(1.02); }
        .setting-icon { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem; }
        .setting-icon i { font-size: 1.2rem; color: white; }
        .bg-icon-blue { background-color: #3b82f6; } .bg-icon-green { background-color: #22c55e; } .bg-icon-orange { background-color: #f97316; } .bg-icon-red { background-color: #ef4444; } .bg-icon-yellow { background-color: #eab308; } .bg-icon-purple { background-color: #8b5cf6; }
        .setting-label { font-size: 1.05rem; font-weight: 600; color: #e5e7eb; }
        .section-header { color: #9ca3af; font-weight: bold; text-transform: uppercase; font-size: 0.8rem; padding: 1.5rem 0.25rem 0.5rem 0.25rem; }
        #payment-content-area { padding-top: 80px !important; }
        .payment-method-btn { background-color: #2a2a2a; border: 1px solid #3a3a3a; transition: all 0.2s ease; }
        .payment-method-btn:hover { background-color: #3a3a3a; transform: translateY(-2px); border-color: #1DB954; }
        .payment-method-img { width: 48px; height: 48px; object-fit: contain; border-radius: 0.75rem; margin-right: 1rem; }
        .swipe-container { position: relative; width: 100%; background-color: #121212; border-radius: 9999px; padding: 6px; overflow: hidden; box-shadow: inset 4px 4px 8px #0c0c0c, inset -4px -4px 8px #1a1a1a; }
        .swipe-text { position: absolute; left: 0; right: 0; top: 50%; transform: translateY(-50%); text-align: center; color: #a1a1aa; font-weight: bold; z-index: 1; pointer-events: none; transition: opacity 0.2s; }
        .swipe-handle { position: relative; z-index: 2; width: 50px; height: 50px; background-image: linear-gradient(to right, #1DB954, #1ed760); border-radius: 50%; cursor: grab; display: flex; align-items: center; justify-content: center; touch-action: none; }
        .swipe-handle:active { transform: scale(1.1); }
        .swipe-track { position: absolute; left: 0; top: 0; height: 100%; background-color: rgba(29, 185, 84, 0.3); border-radius: 9999px; }
        .tx-status { font-size: 0.7rem; font-weight: bold; padding: 2px 8px; border-radius: 9999px; text-transform: capitalize; }
        .tx-status-pending { background-color: #eab308; color: black; }
        .tx-status-approved { background-color: #22c55e; color: white; }
        .tx-status-rejected { background-color: #ef4444; color: white; }
        /* NEW: Deposit page logo animation */
        .deposit-logo-animated {
            border-radius: 1.5rem; /* More rounded */
            animation: float-effect 3s ease-in-out infinite;
        }
        @keyframes float-effect {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
    </style>
</head>
<body class="overflow-hidden">
    
    <div id="page-transition-overlay"></div>

    <!-- Screen 1: Splash -->
    <div id="splash-screen" class="screen bg-black !justify-center">
        <dotlottie-wc id="splash-screen-lottie" src="https://lottie.host/09fd19d9-9bd5-42ca-8089-880621573a27/qqEJoYOp7E.lottie" style="width: 300px; height: 300px" autoplay loop></dotlottie-wc>
        <img id="splash-screen-logo" src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/dfdc00fc6bb93771364bbf5000dad222.jpg?alt=media&token=ff33f08b-1b2e-424e-b636-f664d8044bed" alt="LEVEL UP Logo" class="w-48 h-48 rounded-full">
    </div>

    <!-- Screen 2: Auth -->
    <div id="auth-container" class="screen bg-black hidden !justify-center">
        <div id="login-view" class="auth-view active"><div class="w-full max-w-sm text-white text-center"><img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/dfdc00fc6bb93771364bbf5000dad222.jpg?alt=media&token=ff33f08b-1b2e-424e-b636-f664d8044bed" alt="Logo" class="w-24 h-24 mx-auto mb-4 rounded-full"><h1 class="text-4xl font-bold">SPONSOR PANEL</h1><p class="text-md text-gray-400 mb-10">Welcome Back</p><form id="login-form-element" class="space-y-5"><div class="relative flex items-center w-full input-field rounded-2xl"><i class="fa-solid fa-envelope absolute left-5 text-gray-400"></i><input id="login-email" type="email" placeholder="Email" required class="w-full bg-transparent pl-12 pr-5 py-4 text-white placeholder-gray-400 border-none rounded-2xl focus:outline-none"></div><div class="relative flex items-center w-full input-field rounded-2xl"><i class="fa-solid fa-lock absolute left-5 text-gray-400"></i><input id="login-password" type="password" placeholder="Password" required class="w-full bg-transparent pl-12 pr-12 py-4 text-white placeholder-gray-400 border-none rounded-2xl focus:outline-none"><i id="toggle-login-password" class="fa-solid fa-eye password-toggle"></i></div><div><a href="#" id="forgot-password-link" class="block text-sm text-right text-gray-400 hover:text-white -mt-2 mb-6">Forgot password?</a><button type="submit" class="w-full py-4 rounded-2xl action-button text-lg flex items-center justify-center h-[52px]">Sign In</button></div></form><div class="text-center mt-8 text-base text-gray-400 space-y-4"><p>Don't have an account? <a href="#" id="show-signup" class="font-bold text-[#1DB954] hover:underline">Sign Up</a></p><p><a href="https://t.me/Blackmoney54" target="_blank" rel="noopener noreferrer" class="hover:underline">Contact <span class="text-[#1DB954] font-semibold">Help</span></a></p></div></div></div>
        <div id="signup-view" class="auth-view"><div class="w-full max-w-sm text-white"><div class="text-center mb-6"><img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/dfdc00fc6bb93771364bbf5000dad222.jpg?alt=media&token=ff33f08b-1b2e-424e-b636-f664d8044bed" alt="Logo" class="w-20 h-20 mx-auto mb-3 rounded-full"><h1 class="text-3xl font-bold">Create Sponsor Account</h1></div><form id="signup-form-element" class="space-y-4"><div class="relative flex items-center w-full input-field rounded-xl"><i class="fa-solid fa-user absolute left-5 text-gray-400"></i><input id="signup-fullname" type="text" placeholder="Full Name" required class="w-full bg-transparent pl-12 pr-5 py-3 text-sm text-white placeholder-gray-400 border-none rounded-xl focus:outline-none"></div><div class="relative flex items-center w-full input-field rounded-xl"><i class="fa-solid fa-envelope absolute left-5 text-gray-400"></i><input id="signup-email" type="email" placeholder="Email Address" required class="w-full bg-transparent pl-12 pr-5 py-3 text-sm text-white placeholder-gray-400 border-none rounded-xl focus:outline-none"></div><div class="flex items-center w-full rounded-xl input-field px-5"><i class="fa-brands fa-whatsapp text-gray-400 mr-3 text-lg"></i><span class="text-gray-400 text-sm pr-2">+880</span><input id="signup-whatsapp" type="tel" placeholder="WhatsApp Number" required class="flex-1 bg-transparent py-3 text-sm text-white placeholder-gray-400 border-none focus:outline-none"></div><div class="relative flex items-center w-full input-field rounded-xl"><i class="fa-solid fa-lock absolute left-5 text-gray-400"></i><input id="signup-password" type="password" placeholder="Password" required class="w-full bg-transparent pl-12 pr-12 py-3 text-sm text-white placeholder-gray-400 border-none rounded-xl focus:outline-none"><i id="toggle-signup-password" class="fa-solid fa-eye password-toggle"></i></div><div class="relative flex items-center w-full input-field rounded-xl"><i class="fa-solid fa-lock absolute left-5 text-gray-400"></i><input id="signup-confirm-password" type="password" placeholder="Confirm Password" required class="w-full bg-transparent pl-12 pr-12 py-3 text-sm text-white placeholder-gray-400 border-none rounded-xl focus:outline-none"><i id="toggle-confirm-password" class="fa-solid fa-eye password-toggle"></i></div><p id="password-match-msg" class="text-xs -mt-2 ml-2 h-4"></p><button type="submit" class="w-full py-4 mt-4 rounded-xl action-button text-lg flex items-center justify-center h-[52px]">Sign Up</button></form><div class="text-center mt-4"><p class="text-sm text-gray-400">Already have an account? <a href="#" id="show-login" class="font-bold text-[#1DB954] hover:underline">Sign In</a></p></div></div></div>
    </div>
    
    <!-- Screen 3: Dashboard -->
    <div id="dashboard-screen" class="screen hidden p-0 justify-start">
        <main class="w-full h-full text-white overflow-y-auto no-scrollbar">
            <!-- Headers -->
            <header id="main-header" class="sticky top-0 z-40 bg-[#1e1e1e]/80 backdrop-blur-md border-b border-gray-800 p-3 flex justify-between items-center gap-2 rounded-b-2xl">
                <div class="flex items-center gap-3">
                    <img id="header-user-avatar" src="" class="w-10 h-10 rounded-full border-2 border-gray-700 object-cover">
                    <div><h2 id="header-user-name" class="font-bold text-white flex items-center"></h2></div>
                </div>
                <div id="wallet-button" class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-full p-2 px-4 flex items-center gap-3 cursor-pointer hover:border-green-500 transition-all duration-300">
                    <i class="fa-solid fa-wallet text-xl text-green-400"></i>
                    <div>
                        <p class="text-sm font-bold text-white font-oswald tracking-wider"><span id="header-wallet-balance">0.00</span> <span class="text-xs font-normal text-gray-300">TK</span></p>
                        <p class="text-[10px] text-gray-400 -mt-1 uppercase">Live Balance</p>
                    </div>
                </div>
            </header>
            <header id="add-post-header" class="hidden sticky top-0 z-40 bg-[#1e1e1e]/80 backdrop-blur-md border-b border-gray-800 p-4 text-center rounded-b-2xl">
                <h2 class="text-xl font-bold">Create New Match Post</h2>
            </header>
            <header id="manage-posts-header" class="hidden sticky top-0 z-40 bg-[#1e1e1e]/80 backdrop-blur-md border-b border-gray-800 p-4 flex justify-between items-center rounded-b-2xl">
                <h2 class="text-xl font-bold">Manage Your Posts</h2>
                <button id="header-create-post-btn" class="bg-green-600 hover:bg-green-500 w-10 h-10 rounded-full flex items-center justify-center transition-transform hover:scale-110">
                    <i class="fa-solid fa-plus text-xl"></i>
                </button>
            </header>
             <header id="history-header" class="hidden sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center">
                <button id="back-to-profile-btn" class="header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full"><i class="fa-solid fa-arrow-left"></i></button>
                <h2 class="text-xl font-bold">Event History</h2>
                <div class="w-10"></div>
            </header>
            <header id="kyc-header" class="hidden sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center">
                <button class="back-to-profile-from-subpage header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full"><i class="fa-solid fa-arrow-left"></i></button>
                <h2 class="text-xl font-bold">Organizer Verification</h2>
                <div class="w-10"></div>
            </header>
            <header id="statement-header" class="hidden sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center">
                <button class="back-to-profile-from-subpage header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full"><i class="fa-solid fa-arrow-left"></i></button>
                <h2 class="text-xl font-bold">Events & Earnings</h2>
                <div class="w-10"></div>
            </header>
             <header id="feedback-header" class="hidden sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center">
                <button class="back-to-profile-from-subpage header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full"><i class="fa-solid fa-arrow-left"></i></button>
                <h2 class="text-xl font-bold">User Feedbacks</h2>
                <div class="w-10"></div>
            </header>
            <header id="account-settings-header" class="hidden sticky top-0 z-40 premium-header py-3 px-4 flex justify-between items-center">
                <button class="back-to-profile-from-subpage header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full"><i class="fa-solid fa-arrow-left"></i></button>
                <h2 class="text-xl font-bold">Account Settings</h2>
                <div class="w-10"></div>
            </header>

            <!-- Page Content Area -->
            <div class="w-full">
                <div id="add-post-content" class="dashboard-page hidden p-4 md:p-6">
                    <form id="create-post-form" class="space-y-6">
                        <input type="hidden" id="editing-post-id" value="">
                        <div class="form-section p-4 rounded-xl space-y-4">
                            <div>
                                <label class="form-label">Event Type (Creation Fee Applies)</label>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                    <label>
                                        <input type="radio" name="event-type" value="paid" class="hidden" checked>
                                        <div class="event-type-card p-3 rounded-lg text-center cursor-pointer">
                                            <i class="fa-solid fa-coins text-2xl text-yellow-400"></i>
                                            <p class="font-bold mt-1">Paid Scrim</p>
                                            <p class="text-xs text-gray-400">Fee: 10 TK</p>
                                        </div>
                                    </label>
                                    <label>
                                        <input type="radio" name="event-type" value="practice" class="hidden">
                                        <div class="event-type-card p-3 rounded-lg text-center cursor-pointer relative">
                                            <i class="fa-solid fa-crosshairs text-2xl text-orange-400"></i>
                                            <p class="font-bold mt-1">Practice Match</p>
                                            <p class="text-xs text-gray-400">Fee: 5 TK</p>
                                        </div>
                                    </label>
                                    <label>
                                        <input type="radio" name="event-type" value="promotion" class="hidden" disabled>
                                        <div class="event-type-card disabled p-3 rounded-lg text-center cursor-pointer relative">
                                            <i class="fa-solid fa-bullhorn text-2xl text-blue-400"></i>
                                            <p class="font-bold mt-1">Promotion</p>
                                             <span class="absolute top-1 right-1 text-[9px] bg-gray-500 px-1.5 py-0.5 rounded-full">Only Officials</span>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div><label for="post-event-name" class="form-label">Event Name</label><input id="post-event-name" type="text" placeholder="Enter your Event name" class="form-input" required></div>
                            <div><label for="post-image-upload" class="form-label">Post Image</label><input id="post-image-upload" type="file" accept="image/*" class="hidden" required><label for="post-image-upload" class="cursor-pointer"><div class="w-full h-40 border-2 border-dashed border-gray-600 rounded-xl flex flex-col items-center justify-center text-gray-400 hover:bg-gray-800 hover:border-green-500"><img id="post-image-preview" src="" class="hidden w-full h-full object-cover rounded-xl"><div id="post-image-placeholder"><i class="fa-solid fa-cloud-upload text-4xl"></i><p>Click to upload image</p></div></div></label></div>
                        </div>
                        <div class="form-section p-4 rounded-xl space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="post-battle-type" class="form-label">Battle Type</label><select id="post-battle-type" class="form-select"><option value="Battle Royal">Battle Royal</option><option value="Clash Squad" disabled>Clash Squad (Soon)</option></select></div>
                                <div><label for="post-team-type" class="form-label">Team Type</label><select id="post-team-type" class="form-select"><option value="Squad">Squad</option><option value="Duo">Duo</option><option value="Solo">Solo</option></select></div>
                            </div>
                            <div><label for="post-total-slots" class="form-label">Total Slots</label><input id="post-total-slots" type="number" class="form-input bg-gray-800" readonly></div>
                            <div id="entry-fee-container"><label for="post-entry-fee" class="form-label">Entry Fee (TK)</label><input id="post-entry-fee" type="number" placeholder="e.g., 35" class="form-input" required></div>
                        </div>
                        <div class="form-section p-4 rounded-xl space-y-4"><div class="grid grid-cols-2 gap-4"><div><label for="post-match-date" class="form-label">Match Date</label><input id="post-match-date" type="date" class="form-input" style="color-scheme: dark;" required></div><div><label for="post-num-matches" class="form-label">Number of Matches</label><select id="post-num-matches" class="form-select"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select></div><div><label for="post-idpass-time" class="form-label">ID Pass Time</label><input id="post-idpass-time" type="time" class="form-input" style="color-scheme: dark;" required></div><div><label for="post-matchstart-time" class="form-label">Match Start Time</label><input id="post-matchstart-time" type="time" class="form-input" style="color-scheme: dark;" required></div></div><div><label class="form-label">Select Maps (<span id="map-selection-count">0</span>/<span id="map-selection-limit">1</span>)</label><div id="map-checkboxes-container" class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm"><div class="map-checkbox"><input type="checkbox" id="map1" value="Bermuda" class="hidden"><label for="map1" class="block text-center p-2 rounded-md cursor-pointer">Bermuda</label></div><div class="map-checkbox"><input type="checkbox" id="map2" value="B Remastered" class="hidden"><label for="map2" class="block text-center p-2 rounded-md cursor-pointer">B Remastered</label></div><div class="map-checkbox"><input type="checkbox" id="map3" value="Purgatory" class="hidden"><label for="map3" class="block text-center p-2 rounded-md cursor-pointer">Purgatory</label></div><div class="map-checkbox"><input type="checkbox" id="map4" value="Kalahari" class="hidden"><label for="map4" class="block text-center p-2 rounded-md cursor-pointer">Kalahari</label></div><div class="map-checkbox"><input type="checkbox" id="map5" value="Alpine" class="hidden"><label for="map5" class="block text-center p-2 rounded-md cursor-pointer">Alpine</label></div><div class="map-checkbox"><input type="checkbox" id="map6" value="NeXTerra" class="hidden"><label for="map6" class="block text-center p-2 rounded-md cursor-pointer">NeXTerra</label></div><div class="map-checkbox"><input type="checkbox" id="map7" value="Solara" class="hidden"><label for="map7" class="block text-center p-2 rounded-md cursor-pointer">Solara</label></div></div></div></div>
                        <div id="prize-details-container" class="form-section p-4 rounded-xl space-y-2"><label class="form-label">Winning Prize Details</label><div id="prize-options-container" class="grid grid-cols-2 gap-2 text-sm"></div></div>
                        <div class="form-section p-4 rounded-xl space-y-4">
                            <div class="flex justify-between items-center">
                                <label class="form-label mb-0">নিয়মাবলী</label>
                                <button type="button" id="add-rule-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-md text-sm flex items-center gap-1"><i class="fa-solid fa-plus"></i> আরো যোগ করুন</button>
                            </div>
                            <div id="rules-container" class="space-y-2 mt-2">
                                <div class="relative">
                                    <p class="form-input bg-gray-800 text-gray-400 overflow-x-auto whitespace-nowrap no-scrollbar pr-10">বুক করা স্লট রিফান্ড হবে না।</p>
                                    <i class="fa-solid fa-lock absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                                </div>
                                <div class="relative">
                                    <p class="form-input bg-gray-800 text-gray-400 overflow-x-auto whitespace-nowrap no-scrollbar pr-10">যে টিম মেম্বারদের নিয়ে বুক করা হবে, তারা ছাড়া অন্য কেউ রুমে জয়েন করলে পুরো স্কোয়াডকে কিক দেওয়া হবে।</p>
                                    <i class="fa-solid fa-lock absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                                </div>
                                <!-- NEW RULE ADDED HERE -->
                                <div class="relative">
                                    <p class="form-input bg-gray-800 text-gray-400 overflow-x-auto whitespace-nowrap no-scrollbar pr-10">ম্যাচ, টাকা বা পয়েন্ট নিয়ে কোনো সমস্যা হলে ৩ ঘণ্টার মধ্যে অ্যাডমিনের সাথে যোগাযোগ করতে হবে। এরপর কোনো অভিযোগ গ্রহণ করা হবে না।</p>
                                    <i class="fa-solid fa-lock absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                                </div>
                            </div>
                            <label for="post-tags" class="form-label">Search Tags (Max 5, comma separated)</label><input id="post-tags" type="text" placeholder="e.g., tournament, solo, official" class="form-input">
                        </div>
                        <button type="submit" id="create-post-submit-btn" class="w-full py-4 mt-4 rounded-xl action-button text-lg flex items-center justify-center h-[52px]" data-create-text="Create Post" data-edit-text="Update Post">Create Post</button>
                    </form>
                </div>
                
                <div id="manage-posts-content" class="dashboard-page p-4 md:p-6">
                    <div class="flex gap-2 mb-4">
                        <button class="tab-button manage-posts-tab" data-target="event-post-section">My Events</button>
                        <button class="tab-button manage-posts-tab" data-target="event-live-section">Live Match</button>
                    </div>
                    <div id="event-post-section" class="tab-content-section space-y-4"><div id="event-post-container"></div></div>
                    <div id="event-live-section" class="tab-content-section space-y-4"><div id="event-live-container"></div></div>
                </div>

                <div id="wallet-content" class="dashboard-page hidden p-6 pt-10">
                    <h1 class="text-4xl font-bold mb-8">My Wallet</h1>
                    <div class="space-y-6 max-w-2xl mx-auto">
                        <div class="bg-gradient-to-br from-blue-900 to-purple-900 border border-blue-700 rounded-3xl p-6 shadow-lg text-left">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-lg text-blue-200">Live Balance</p>
                                    <h2 class="text-4xl font-bold text-white my-1"><span id="wallet-live-balance">0.00</span> <span class="text-xl font-normal">TK</span></h2>
                                </div>
                                <i class="fa-solid fa-money-bill-wave text-5xl text-blue-500/50"></i>
                            </div>
                        </div>
                    </div>
                    <!-- MODIFIED: Added Events & Earnings button -->
                    <div class="mt-8 max-w-2xl mx-auto space-y-3">
                         <button id="deposit-btn" class="w-full py-3 rounded-lg manage-btn text-white font-bold transition-colors"><i class="fa-solid fa-plus-circle mr-2"></i> Deposit Money</button>
                         <button id="withdraw-btn" class="w-full py-3 rounded-lg manage-btn text-white font-bold transition-colors"><i class="fa-solid fa-arrow-circle-down mr-2"></i> Withdraw Money</button>
                         <button id="go-to-statement-btn" class="w-full py-3 rounded-lg manage-btn bg-gradient-to-br from-purple-600 to-indigo-600 text-white font-bold transition-colors"><i class="fa-solid fa-chart-line mr-2"></i> Events & Earnings</button>
                    </div>
                </div>

                <div id="mailbox-content" class="dashboard-page hidden p-4 md:p-6"></div>

                <div id="profile-content" class="dashboard-page hidden p-4">
                    <div class="flex items-center p-4 bg-[#2a2a2a] rounded-xl border border-gray-700 mb-6">
                        <img id="profile-page-avatar" src="" class="w-16 h-16 rounded-full object-cover border-2 border-gray-600">
                        <div class="ml-4">
                            <h2 id="dashboard-user-name" class="text-xl font-bold text-white truncate flex items-center"></h2>
                            <p id="dashboard-user-email" class="text-sm text-gray-400 truncate"></p>
                        </div>
                    </div>

                    <div class="w-full max-w-2xl mx-auto p-4 bg-[#1e1e1e] border border-gray-800 rounded-xl grid grid-cols-3 text-center divide-x divide-gray-700 mb-6">
                        <div><p class="text-2xl font-bold" id="sponsor-total-likes">0</p><p class="text-xs text-gray-400">Likes</p></div>
                        <div><p class="text-2xl font-bold" id="sponsor-avg-rating">0.0</p><p class="text-xs text-gray-400">Rating</p></div>
                        <div><p class="text-2xl font-bold" id="sponsor-success-rate">0%</p><p class="text-xs text-gray-400">Success</p></div>
                    </div>

                    <div id="pro-organizer-progress-section" class="w-full max-w-2xl mx-auto mb-6 p-6 bg-[#1e1e1e] border border-gray-800 rounded-xl hidden">
                        <div class="flex flex-col items-center text-center mb-4">
                            <img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Levelup%2F1762353999007.png?alt=media&token=bb009272-ee52-4936-a350-e31bbec1ef90" alt="Badge Preview" class="w-20 h-20 mb-2">
                            <h3 class="text-xl font-bold text-white">Top Rated Sponsor Badge</h3>
                        </div>
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-1 text-sm"><span class="font-semibold"><i class="fa-solid fa-trophy mr-2 text-yellow-400"></i>Completed Matches</span><span id="pro-matches-counter" class="font-bold">0 / 500</span></div>
                            <div class="w-full bg-gray-700 rounded-full h-2.5"><div id="pro-matches-progress" class="bg-yellow-400 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                        </div>
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-1 text-sm"><span class="font-semibold"><i class="fa-solid fa-heart mr-2 text-pink-500"></i>Sponsor Likes</span><span id="pro-likes-counter" class="font-bold">0 / 1000</span></div>
                            <div class="w-full bg-gray-700 rounded-full h-2.5"><div id="pro-likes-progress" class="bg-pink-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                        </div>
                        <p class="text-xs text-center text-gray-400 mb-4">Complete the requirements to unlock the "Veteran Sponsor" badge.</p>
                        <button id="apply-pro-badge-btn" class="w-full py-3 rounded-lg action-button" disabled>Apply for Badge</button>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <h4 class="section-header">Account</h4>
                            <div class="space-y-3">
                                <button id="kyc-button" class="setting-item"><div class="flex items-center"><div class="setting-icon bg-icon-green"><i class="fa-solid fa-user-check"></i></div><span class="setting-label">Organizer Verification</span></div><i class="fa-solid fa-chevron-right text-gray-500"></i></button>
                                <button id="account-settings-button" class="setting-item"><div class="flex items-center"><div class="setting-icon bg-icon-blue"><i class="fa-solid fa-user-cog"></i></div><span class="setting-label">Account Settings</span></div><i class="fa-solid fa-chevron-right text-gray-500"></i></button>
                                <button id="statement-button" class="setting-item"><div class="flex items-center"><div class="setting-icon bg-icon-purple"><i class="fa-solid fa-chart-line"></i></div><span class="setting-label">Events & Earnings</span></div><i class="fa-solid fa-chevron-right text-gray-500"></i></button>
                                <button id="feedback-button" class="setting-item"><div class="flex items-center"><div class="setting-icon bg-icon-yellow"><i class="fa-solid fa-comment-dots"></i></div><span class="setting-label">Feedbacks</span></div><i class="fa-solid fa-chevron-right text-gray-500"></i></button>
                                <button id="history-button" class="setting-item"><div class="flex items-center"><div class="setting-icon bg-icon-orange"><i class="fa-solid fa-history"></i></div><span class="setting-label">Event History</span></div><i class="fa-solid fa-chevron-right text-gray-500"></i></button>
                                <button id="logout-button-mobile" class="setting-item"><div class="flex items-center"><div class="setting-icon bg-icon-red"><i class="fa-solid fa-arrow-right-from-bracket"></i></div><span class="setting-label">Logout</span></div><i class="fa-solid fa-chevron-right text-gray-500"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="feedback-content" class="dashboard-page hidden p-4 md:p-6"></div>
                <div id="history-content" class="dashboard-page hidden p-4 md:p-6"></div>
                <div id="kyc-content" class="dashboard-page hidden p-4 md:p-6"></div>
                <div id="statement-content" class="dashboard-page hidden p-4 md:p-6"></div>
                <div id="account-settings-content" class="dashboard-page hidden p-4 md:p-6">
                    <div class="max-w-md mx-auto space-y-8">
                        <!-- Change Display Name Section -->
                        <div class="form-section p-4 rounded-xl">
                            <h3 class="text-lg font-bold mb-3">Change Display Name</h3>
                            <form id="change-name-form" class="space-y-3">
                                <div>
                                    <label for="new-display-name" class="form-label">New Name</label>
                                    <input id="new-display-name" type="text" placeholder="Enter new display name" class="form-input" required>
                                    <p class="text-xs text-gray-500 mt-2">You can change your name once every 30 days.</p>
                                </div>
                                <button type="submit" id="save-display-name-btn" class="w-full py-3 rounded-lg action-button">Save Name</button>
                            </form>
                        </div>
                
                        <!-- Change Password Section -->
                        <div class="form-section p-4 rounded-xl">
                            <h3 class="text-lg font-bold mb-3">Change Password</h3>
                            <form id="change-password-form" class="space-y-3">
                                <input type="password" id="current-password" placeholder="Current Password" class="form-input" required autocomplete="current-password">
                                <input type="password" id="new-password" placeholder="New Password" class="form-input" required autocomplete="new-password">
                                <input type="password" id="confirm-new-password" placeholder="Confirm New Password" class="form-input" required autocomplete="new-password">
                                <button type="submit" id="update-password-btn" class="w-full py-3 rounded-lg action-button">Update Password</button>
                            </form>
                        </div>
                
                        <!-- Danger Zone Section -->
                        <div class="bg-red-900/20 border border-red-500/30 p-4 rounded-xl">
                            <h3 class="text-lg font-bold text-red-400">Danger Zone</h3>
                            <p class="text-sm text-gray-400 my-2">Permanently delete your account and all associated data. This action cannot be undone.</p>
                            <button id="delete-account-btn" class="w-full py-3 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold transition-all">Delete Account</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <div class="nav-container">
             <nav class="nav-bar">
                <div id="nav-indicator"></div>
                <a href="#" id="nav-manage-posts" class="nav-item active"><i class="fa-solid fa-tasks nav-icon"></i><span class="nav-label">Manage</span></a>
                <a href="#" id="nav-wallet" class="nav-item"><i class="fa-solid fa-wallet nav-icon"></i><span class="nav-label">Wallet</span></a>
                <a href="#" id="nav-mailbox" class="nav-item relative"><i class="fa-solid fa-envelope nav-icon"></i><span class="nav-label">Mailbox</span></a>
                <a href="#" id="nav-profile" class="nav-item"><i class="fa-solid fa-user nav-icon"></i><span class="nav-label">Profile</span></a>
            </nav>
        </div>
    </div>
    
    <!-- Fullscreen Overlays for Sponsor -->
    <div id="sponsor-live-view-screen" class="screen hidden !p-0 justify-start">
        <div id="sponsor-live-view-content" class="w-full h-full bg-[#121212] text-white overflow-y-auto no-scrollbar relative"></div>
    </div>
    <div id="participant-list-screen" class="screen hidden !p-0 justify-start"><div id="participant-list-content" class="w-full h-full bg-[#121212] text-white overflow-y-auto no-scrollbar relative p-4 md:p-6"></div></div>
    <div id="payment-screen" class="screen hidden !p-0 justify-start">
        <header id="payment-header" class="hidden absolute top-0 left-0 w-full z-50 premium-header py-3 px-4 flex justify-between items-center">
            <button id="back-from-payment-btn" class="header-back-btn text-gray-300 text-xl w-10 h-10 flex items-center justify-center rounded-full"><i class="fa-solid fa-arrow-left"></i></button>
            <h2 class="text-xl font-bold">Payment</h2>
            <div class="w-10"></div>
        </header>
        <div id="payment-content-area" class="w-full h-full bg-[#121212] text-white overflow-y-auto no-scrollbar relative p-4 md:p-6"></div>
    </div>


    <!-- Modals -->
    <div id="modal-screen" class="screen hidden !justify-center"></div>
    <div id="forgot-password-modal" class="screen hidden !justify-center"><div class="modal-box rounded-3xl p-6 text-white text-center flex flex-col items-center relative"><button id="close-forgot-modal" class="absolute top-3 right-4 text-gray-400 hover:text-white text-2xl">&times;</button><h3 class="text-2xl font-bold mb-2">Reset Password</h3><p class="text-gray-300 text-sm mb-6">Enter your email and we'll send you a reset link.</p><form id="forgot-password-form" class="w-full"><div class="relative flex items-center w-full input-field rounded-xl mb-4"><i class="fa-solid fa-envelope absolute left-5 text-gray-400"></i><input id="forgot-email-input" type="email" placeholder="Your Email Address" required class="w-full bg-transparent pl-12 pr-5 py-3 text-white placeholder-gray-400 border-none rounded-xl focus:outline-none"></div><button type="submit" class="w-full py-3 rounded-xl action-button text-base flex items-center justify-center h-[44px]">Send Reset Link</button></form></div></div>
    <div id="id-pass-modal" class="screen hidden !justify-center"><div class="modal-box rounded-3xl p-6 text-white flex flex-col items-center relative"><button id="close-idpass-modal" class="absolute top-3 right-4 text-gray-400 hover:text-white text-2xl">&times;</button><h3 class="text-2xl font-bold mb-4 w-full text-center">Set Room Details</h3><div class="text-sm text-yellow-300 bg-yellow-900/50 border border-yellow-800 rounded-lg p-3 mb-4"><p class="font-semibold">গুরুত্বপূর্ণ নোটিশ:</p><ul class="list-disc list-inside text-left mt-1 text-xs"><li>অনুগ্রহ করে ম্যাচটি নির্ধারিত সময়ে শুরু করুন।</li><li>একাধিক ম্যাপ থাকলে, প্রতিটি ম্যাচ শেষ হওয়ার পর ৩০ সেকেন্ডের বেশি অপেক্ষা করবেন না।</li></ul></div><form id="id-pass-form" class="w-full space-y-4"><input type="hidden" id="idpass-post-id"><div class="w-full"><label for="room-id-input" class="form-label">Room ID</label><input id="room-id-input" type="text" placeholder="Enter Room ID" required class="form-input"></div><div class="w-full"><label for="room-pass-input" class="form-label">Password</label><input id="room-pass-input" type="text" placeholder="Enter Room Password" required class="form-input"></div><button type="submit" class="w-full py-3 mt-2 rounded-xl action-button text-base flex items-center justify-center h-[44px]">Submit ID & Pass</button></form></div></div>
    <div id="edit-points-modal" class="screen hidden !justify-center"><div id="edit-points-modal-box" class="modal-box rounded-lg p-6"></div></div>
    <div id="ban-team-modal" class="screen hidden !justify-center"><div id="ban-team-modal-box" class="modal-box rounded-lg p-6"></div></div>

    <!-- NEW Loading Overlay -->
    <div id="loading-overlay" class="screen hidden !justify-center" style="z-index: 1001; background-color: rgba(18, 18, 18, 0.8); backdrop-filter: blur(8px);">
        <div class="text-center">
            <dotlottie-wc src="https://lottie.host/e21415f9-b849-4323-8646-a2e3f1699933/i57m53VT2e.lottie" style="width: 200px; height: 200px;" autoplay loop></dotlottie-wc>
            <p id="loading-text" class="text-white font-semibold mt-4 text-lg">Processing...</p>
        </div>
    </div>

    <!-- Image Lightbox -->
    <div id="image-lightbox" class="screen hidden !justify-center" onclick="hideLightbox()">
        <button class="absolute top-4 right-4 text-white text-4xl">&times;</button>
        <img id="lightbox-img" src="" alt="Screenshot" onclick="event.stopPropagation()">
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
        // --- Firebase Config (SAME AS USER APP) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBLhxlVr8mjel_rVI1xqeRJ2DSywjiI2ek",
            authDomain: "nxzwallet.firebaseapp.com",
            databaseURL: "https://nxzwallet-default-rtdb.firebaseio.com",
            projectId: "nxzwallet",
            storageBucket: "nxzwallet.appspot.com",
            messagingSenderId: "910859278641",
            appId: "1:910859278641:web:d896205c530816fb297810" 
        };
        
        // **UPDATED**: Initialize Firebase with a unique name for the sponsor app
        // This prevents session conflicts with the user app if they are on the same domain.
        if (!firebase.apps.find(app => app.name === 'sponsorApp')) {
            firebase.initializeApp(firebaseConfig, 'sponsorApp');
        }
        
        const sponsorApp = firebase.app('sponsorApp');
        const auth = sponsorApp.auth();
        const database = sponsorApp.database();
        const storage = sponsorApp.storage();

        const WORKER_URL = "https://levelup-image-uploader.smbadsha544.workers.dev";
        const MAX_FILE_SIZE_KB = 2048;

        function showCustomModal(config) {
            const { type = 'error', title, message, primaryButton, secondaryButton } = config;
            const modalScreen = document.getElementById('modal-screen');
            if (!modalScreen) return;

            // MODIFIED: Added 'confirm' type which uses a static icon instead of Lottie
            const iconHTMLs = {
                success: '<dotlottie-wc src="https://lottie.host/eda3572d-13ba-488f-a99f-93a027e02e86/46P9bapUv1.lottie" autoplay loop style="width: 100%; height: 100%;"></dotlottie-wc>',
                error: '<dotlottie-wc src="https://lottie.host/adeb3497-0612-44f8-bddc-c7c564f22c9b/ypALfoP56V.lottie" autoplay loop style="width: 100%; height: 100%;"></dotlottie-wc>',
                confirm: '<i class="fa-solid fa-satellite-dish text-green-400 text-6xl animate-pulse"></i>'
            };
            const iconContainerClass = type === 'confirm' ? 'w-24 h-24 -mt-16 flex items-center justify-center' : 'w-24 h-24 -mt-16';

            let buttonsHTML = '';
            if (primaryButton) {
                const buttonClass = (type === 'success' && !secondaryButton) ? 'bg-green-600 hover:bg-green-700' : 'action-button';
                buttonsHTML += primaryButton.link 
                    ? `<a href="${primaryButton.link}" target="_blank" class="w-full py-3 mb-2 rounded-xl ${buttonClass} text-base inline-block">${primaryButton.text}</a>`
                    : `<button id="custom-modal-primary-btn" class="w-full py-3 mb-2 rounded-xl ${buttonClass} text-base">${primaryButton.text}</button>`;
            }
            if (secondaryButton) {
                buttonsHTML += `<button id="custom-modal-secondary-btn" class="w-full py-3 rounded-xl bg-gray-600 hover:bg-gray-700 text-base">${secondaryButton.text}</button>`;
            }
            
            const isCustomHtmlMessage = typeof message === 'string' && message.trim().startsWith('<');

            modalScreen.innerHTML = `
                <div class="modal-box rounded-3xl p-6 text-white text-center flex flex-col items-center relative">
                    <div class="${iconContainerClass}">
                        ${iconHTMLs[type] || iconHTMLs['error']}
                    </div>
                    <h3 class="text-2xl font-bold mt-2 mb-2">${title}</h3>
                    <div class="text-gray-300 text-sm mb-6">${isCustomHtmlMessage ? message : `<p>${message}</p>`}</div>
                    ${buttonsHTML}
                </div>`;
            
            modalScreen.classList.remove('hidden');

            const closeModal = () => {
                modalScreen.classList.add('hidden');
            };

            const primaryBtnEl = document.getElementById('custom-modal-primary-btn');
            const secondaryBtnEl = document.getElementById('custom-modal-secondary-btn');

            if (primaryBtnEl && primaryButton.onClick) {
                primaryBtnEl.addEventListener('click', () => {
                    primaryButton.onClick();
                    if (!primaryButton.noClose) closeModal();
                }, { once: true });
            }
            if (secondaryBtnEl) {
                secondaryBtnEl.addEventListener('click', () => {
                    if (secondaryButton.onClick) secondaryButton.onClick();
                    closeModal();
                }, { once: true });
            } else if (!primaryButton || !primaryButton.link) {
                 const singleButton = primaryBtnEl || document.querySelector('.action-button');
                 if(singleButton) singleButton.addEventListener('click', closeModal, { once: true });
            }
        }

        const showModal = (type, title, message, buttonText = 'Continue', onContinue = null) => {
            showCustomModal({
                type: type,
                title: title,
                message: message,
                primaryButton: { text: buttonText, onClick: onContinue }
            });
        };

        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingTextEl = document.getElementById('loading-text');

        function showLoader(text = 'Processing...') {
            if (loadingOverlay) {
                loadingTextEl.textContent = text;
                loadingOverlay.classList.remove('hidden');
            }
        }

        function hideLoader() {
            if (loadingOverlay) {
                loadingOverlay.classList.add('hidden');
            }
        }
        
        function updateTotalStorage(sizeDifference) {
            if (typeof sizeDifference !== 'number') return;
            const storageRef = database.ref('/admin/storage/totalUsedKB');
            storageRef.transaction(currentTotal => {
                return (currentTotal || 0) + sizeDifference;
            });
        }

        async function uploadImage(file, path) {
            if (!file) return null;

            const MAX_FILE_SIZE_BYTES = MAX_FILE_SIZE_KB * 1024;
            if (file.size > MAX_FILE_SIZE_BYTES) {
                showCustomModal({
                    title: "ফাইল সাইজ অনেক বড়",
                    message: `দুঃখিত, আপনি 2 MB এর চেয়ে বড় ফাইল আপলোড করতে পারবেন না। <br> অনুগ্রহ করে নিচের বাটনটি ব্যবহার করে ছবির সাইজ কমান এবং আবার চেষ্টা করুন।`,
                    primaryButton: { text: "ছবির সাইজ কমান", link: "https://www.reduceimages.com/" },
                    secondaryButton: { text: "বন্ধ করুন" }
                });
                return null;
            }

            const formData = new FormData();
            formData.append('file', file);
            
            showLoader('Uploading Image...');

            try {
                const response = await fetch(WORKER_URL, { method: 'POST', body: formData });
                if (!response.ok) throw new Error(`Upload failed with status ${response.status}`);
                
                const result = await response.json();
                if (result.success && result.downloadURL) {
                    return { url: result.downloadURL, size: result.fileSizeKB };
                } else {
                    throw new Error(result.error || 'Worker did not return a valid URL.');
                }
            } catch (error) {
                console.error("Image upload via Worker failed:", error);
                handleFirebaseError({ message: "Image upload failed. Please try again." });
                return null;
            } finally {
                hideLoader();
            }
        }
        

        // --- Global Variables ---
        window.dbData = { users: {}, posts: {} };
        const DEFAULT_AVATAR = "https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/dfdc00fc6bb93771364bbf5000dad222.jpg?alt=media&token=ff33f08b-1b2e-424e-b636-f664d8044bed";
        let currentPaymentData = {};
        
        // --- Payment & Withdrawal Rules ---
        // MODIFIED: Minimum withdraw changed to 100
        const MIN_DEPOSIT = 50; const MAX_DEPOSIT = 5000; const MIN_WITHDRAW = 100; const MAX_WITHDRAW = 5000; const WITHDRAW_LIMIT_PER_DAY = 2;
        const paymentMethods = {
            bkash: { name: 'bKash', logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQQ_HdpMiHFyZ_YfUCB_-vNcDujA8hYsYys91VA0TCyzQ&s=10', number: '01647712206', type: 'Send Money' },
            nagad: { name: 'Nagad', logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTeLPfqiqpP3bbq8yh5BaQeIfvjvn3auAfy0xUP4GHoDw&s', number: '01647712206', type: 'Send Money' },
            rocket: { name: 'Rocket', logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQnNnydSE3RbmYHBeYiFeuxbin5CoY1G_uGC6n9gG3CPw&s=10', number: '016477122060', type: 'Send Money' }
        };

        function timeAgo(isoDateString) {
            const date = new Date(isoDateString); const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 2) return `just now`; if (seconds < 60) return `${seconds}s ago`; const minutes = Math.floor(seconds / 60); if (minutes < 60) return `${minutes}m ago`; const hours = Math.floor(minutes / 60); if (hours < 24) return `${hours}h ago`; const days = Math.floor(hours / 24); return `${days}d ago`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const screens = { splash: document.getElementById('splash-screen'), auth: document.getElementById('auth-container'), dashboard: document.getElementById('dashboard-screen'), modal: document.getElementById('modal-screen'), forgot: document.getElementById('forgot-password-modal'), idpass: document.getElementById('id-pass-modal'), sponsorLive: document.getElementById('sponsor-live-view-screen'), participants: document.getElementById('participant-list-screen'), editPoints: document.getElementById('edit-points-modal'), banTeam: document.getElementById('ban-team-modal'), payment: document.getElementById('payment-screen') };
            const authViews = { login: document.getElementById('login-view'), signup: document.getElementById('signup-view') };
            let isInitialAuthCheck = true, currentUserData = null;
            
            const handleFirebaseError = (err) => { showModal('error', 'An Error Occurred', err.message, 'Try Again'); };

            const populateDashboard = (user, userData) => {
                if (!user || !userData) return;
                currentUserData = userData;
                const name = user.displayName || userData.name; const avatar = userData.avatar || DEFAULT_AVATAR;
                const userNameEl = document.getElementById('header-user-name');
                const dashboardNameEl = document.getElementById('dashboard-user-name');

                const allBadges = window.dbData?.admin?.config?.verifiedBadges || {};
                let verifiedBadgeHTML = '';
                if (userData.verifiedBadge !== undefined && userData.verifiedBadge !== null) {
                    const badgeData = allBadges[userData.verifiedBadge];
                     if (badgeData) {
                        verifiedBadgeHTML = badgeData.type === 'video'
                        ? `<video src="${badgeData.url}" class="verification-badge" autoplay loop muted playsinline></video>`
                        : `<img src="${badgeData.url}" alt="${badgeData.title}" class="verification-badge">`;
                    }
                }
                
                userNameEl.innerHTML = name + verifiedBadgeHTML;
                dashboardNameEl.innerHTML = name + verifiedBadgeHTML;
                
                document.getElementById('dashboard-user-email').textContent = user.email; document.getElementById('header-user-avatar').src = avatar; document.getElementById('profile-page-avatar').src = avatar;
                document.getElementById('header-wallet-balance').textContent = (userData.wallet?.live || 0).toFixed(2);
                document.getElementById('wallet-live-balance').textContent = (userData.wallet?.live || 0).toFixed(2);
                
                updateMailboxBadge();
            };
            
            const startApp = (user) => {
                database.ref('/users/' + user.uid).once('value').then(snapshot => {
                    const userData = snapshot.val();
                    if (!userData || userData.role !== 'sponsor') {
                         showModal('error', 'Access Denied', 'This account does not have sponsor privileges. Please use the user app to log in.', 'OK', () => auth.signOut());
                         return;
                    }

                    // If role is correct, start the main data listener
                    database.ref().on('value', (snapshot) => {
                        window.dbData = snapshot.val() || { users: {}, posts: {} };
                        const currentSponsorData = window.dbData.users?.[user.uid];
                        
                        if (!currentSponsorData) { auth.signOut(); return; }
                        
                        // Auto-assign verified badge (index 0) if KYC is verified and no badge is set
                        if (currentSponsorData.kycStatus === 'verified' && (currentSponsorData.verifiedBadge === undefined || currentSponsorData.verifiedBadge === null)) {
                            database.ref('users/' + user.uid + '/verifiedBadge').set(0);
                        }
                        
                        if (isInitialAuthCheck) {
                             isInitialAuthCheck = false;
                             runSplashAnimation(() => {
                                screens.dashboard.classList.remove('hidden');
                                setTimeout(() => {
                                    setActiveNavItem(document.getElementById('nav-manage-posts'));
                                    navigateToPage('manage-posts-content', true);
                                    checkTimedEvents();
                                    setInterval(updateAllTimers, 1000); // Start the global timer
                                }, 50);
                            });
                        }
                        
                        populateDashboard(user, currentSponsorData);
                        const currentPage = document.querySelector('.dashboard-page:not(.hidden)');
                        const liveViewScreen = document.getElementById('sponsor-live-view-screen');
                        const participantsScreen = document.getElementById('participant-list-screen');
                        
                        if (liveViewScreen && !liveViewScreen.classList.contains('hidden')) {
                            const postId = liveViewScreen.dataset.postId;
                            const post = window.dbData.posts[postId];
                            const activeTabTarget = document.querySelector('#sponsor-live-view-content .active-tab')?.dataset.target;
                            if (post && (post.status === 'completed' || post.status === 'cancelled')) {
                                renderSponsorHistoryView(postId);
                            } else if (postId) {
                                renderSponsorLiveView(postId, activeTabTarget);
                            }
                        } else if (participantsScreen && !participantsScreen.classList.contains('hidden')) {
                             const postId = participantsScreen.dataset.postId;
                             if(postId) showParticipantList(postId);
                        } else if (currentPage && !currentPage.classList.contains('hidden')) {
                            switch(currentPage.id) {
                                case 'manage-posts-content': renderManagePostsPage(); break;
                                case 'profile-content': calculateAndDisplayReputation(); renderProOrganizerProgress(); break;
                                case 'mailbox-content': renderMailbox(); break;    
                                case 'history-content': renderHistoryPage(); break;
                                case 'kyc-content': renderKycPage(); break;
                                case 'statement-content': renderEventsAndEarningsPage(); break;
                                case 'feedback-content': renderFeedbackPage(); break;
                            }
                        }
                    });
                });
            };

            const runSplashAnimation = (onComplete) => {
                setTimeout(() => { document.getElementById('splash-screen-lottie').classList.add('fade-out'); document.getElementById('splash-screen-logo').classList.add('fade-in'); }, 2000);
                setTimeout(() => { document.getElementById('splash-screen').classList.add('hidden'); if(onComplete) onComplete(); }, 3000);
            };

            const startAuthFlow = () => { runSplashAnimation(() => { screens.auth.classList.remove('hidden'); }); };

            auth.onAuthStateChanged(user => { 
                if (user) {
                    if (isInitialAuthCheck) startApp(user);
                } else {
                    isInitialAuthCheck = false;
                    Object.values(screens).forEach(s => s.classList.add('hidden'));
                    screens.splash.classList.remove('hidden');
                    startAuthFlow();
                }
            });
            
            document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); authViews.login.classList.remove('active'); authViews.signup.classList.add('active'); });
            document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); authViews.signup.classList.remove('active'); authViews.login.classList.add('active'); });
            document.getElementById('forgot-password-link').addEventListener('click', (e) => { e.preventDefault(); screens.forgot.classList.remove('hidden'); });
            document.getElementById('close-forgot-modal').addEventListener('click', () => screens.forgot.classList.add('hidden'));
            
            const handleFormSubmit = (form, loadingText, promiseProvider) => {
                const btn = form.querySelector('button[type="submit"]');
                if (btn) btn.disabled = true;
                showLoader(loadingText);
                return promiseProvider()
                    .catch(handleFirebaseError)
                    .finally(() => {
                        if (btn) btn.disabled = false;
                        hideLoader();
                    });
            };

            document.getElementById('forgot-password-form').addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('forgot-email-input').value; handleFormSubmit(e.target, 'Sending link...', () => auth.sendPasswordResetEmail(email).then(() => { screens.forgot.classList.add('hidden'); showModal('success', 'Email Sent', 'A password reset link has been sent to your email address.'); })); });

            document.getElementById('signup-form-element').addEventListener('submit', (e) => {
                e.preventDefault();
                const form = e.target;
                handleFormSubmit(form, 'Signing Up...', async () => {
                    const email = document.getElementById('signup-email').value;
                    const password = document.getElementById('signup-password').value;
                    const confirmPassword = document.getElementById('signup-confirm-password').value;
                    const fullName = document.getElementById('signup-fullname').value;
                    const whatsapp = document.getElementById('signup-whatsapp').value;
            
                    if (password !== confirmPassword) {
                        return Promise.reject({ message: 'Passwords do not match.' });
                    }
            
                    const emailExistsSnapshot = await database.ref('users').orderByChild('email').equalTo(email).once('value');
                    if (emailExistsSnapshot.exists()) {
                        return Promise.reject({ message: 'This email is already registered. Please try logging in.' });
                    }
            
                    const cred = await auth.createUserWithEmailAndPassword(email, password);
                    const user = cred.user;
                    await user.updateProfile({ displayName: fullName });
                    
                    const newSponsorData = {
                        name: fullName,
                        email: email,
                        whatsapp: '+880' + whatsapp,
                        avatar: DEFAULT_AVATAR,
                        role: 'sponsor',
                        wallet: { live: 0, event: 0 },
                        reputation: { likes: 0, likedBy: {} },
                        mailbox: {},
                        analytics: { totalProfit: 0, lastMatchProfit: 0, totalGiveawayValue: 0, giveawayMatches: 0, autoCancelCount: 0 },
                        kycStatus: 'none',
                        nameLastChanged: 0
                    };
                    
                    await database.ref('users/' + user.uid).set(newSponsorData);
                }).then(() => {
                    showModal('success', 'Registration Successful!', 'Your sponsor account has been created.', 'Go to Home', () => {
                        screens.auth.classList.add('hidden');
                        isInitialAuthCheck = true; 
                        auth.onAuthStateChanged(user => { if (user) startApp(user); });
                    });
                });
            });

            document.getElementById('login-form-element').addEventListener('submit', (e) => { 
                e.preventDefault(); 
                handleFormSubmit(e.target, 'Signing In...', () => 
                    auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value)
                ).then(() => {
                    screens.auth.classList.add('hidden');
                    isInitialAuthCheck = true;
                }); 
            });

            document.getElementById('logout-button-mobile').addEventListener('click', () => { auth.signOut().then(() => { window.location.reload(); }); });
            
            const postImageUploadInput = document.getElementById('post-image-upload');
            const postImagePreview = document.getElementById('post-image-preview');
            const postImagePlaceholder = document.getElementById('post-image-placeholder');

            postImageUploadInput.addEventListener('change', e => {
                if (e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        postImagePreview.src = ev.target.result;
                        postImagePreview.classList.remove('hidden');
                        postImagePlaceholder.classList.add('hidden');
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });

            document.getElementById('add-rule-btn').addEventListener('click', () => {
                const container = document.getElementById('rules-container');
                const ruleCount = container.querySelectorAll('.custom-rule').length + 4; // +4 for the 3 fixed rules
                const ruleWrapper = document.createElement('div');
                ruleWrapper.className = 'relative flex items-center custom-rule';
                
                const newRuleInput = document.createElement('input');
                newRuleInput.type = 'text';
                newRuleInput.className = 'form-input rule-input pr-10';
                newRuleInput.placeholder = `নিয়ম #${ruleCount}`;
                newRuleInput.required = true;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'button';
                deleteBtn.className = 'absolute right-3 text-red-500 hover:text-red-400 focus:outline-none';
                deleteBtn.innerHTML = '<i class="fa-solid fa-trash-can"></i>';
                deleteBtn.onclick = () => ruleWrapper.remove();
                
                ruleWrapper.appendChild(newRuleInput);
                ruleWrapper.appendChild(deleteBtn);
                container.appendChild(ruleWrapper);
                newRuleInput.focus();
            });

            document.querySelectorAll('input[name="event-type"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const isPractice = e.target.value === 'practice';
                    document.getElementById('entry-fee-container').style.display = isPractice ? 'none' : 'block';
                    document.getElementById('prize-details-container').style.display = isPractice ? 'none' : 'block';
                    if (isPractice) {
                        document.getElementById('post-entry-fee').value = 0;
                        document.getElementById('post-entry-fee').required = false;
                    } else {
                        document.getElementById('post-entry-fee').required = true;
                    }
                });
            });

            const prizeContainer = document.getElementById('prize-options-container');
            const teamTypeSelect = document.getElementById('post-team-type');
            
            function updatePrizesAndSlots() {
                const teamType = teamTypeSelect.value;
                let slots, prizeRanks;
                if (teamType === 'Solo') { slots = 48; } else if (teamType === 'Duo') { slots = 24; } else { slots = 12; }
                prizeRanks = Array.from({ length: slots }, (_, i) => `Top ${i + 1}`);
                document.getElementById('post-total-slots').value = slots;
                prizeContainer.innerHTML = '';
                prizeRanks.forEach(prize => {
                    const id = prize.replace(/\s+/g, '-').toLowerCase();
                    prizeContainer.innerHTML += `<div class="prize-checkbox bg-gray-800 p-2 rounded-md"><label for="prize-${id}" class="flex items-center cursor-pointer"><input type="checkbox" id="prize-${id}" class="hidden" data-prize-name="${prize}"><div class="w-5 h-5 border-2 border-gray-500 rounded-sm mr-3 flex-shrink-0 flex items-center justify-center"><i class="fa-solid fa-check text-white hidden"></i></div><span>${prize}</span></label><div class="prize-input-container"><input type="number" placeholder="Prize Amount (TK)" class="form-input text-sm p-2 w-full"></div></div>`;
                });
            }
            teamTypeSelect.addEventListener('change', updatePrizesAndSlots);
            updatePrizesAndSlots();

            prizeContainer.addEventListener('change', e => { if (e.target.type === 'checkbox') { const prizeCheckboxDiv = e.target.closest('.prize-checkbox'); const inputContainer = prizeCheckboxDiv.querySelector('.prize-input-container'); const checkIcon = prizeCheckboxDiv.querySelector('.fa-check'); if (e.target.checked) { inputContainer.style.maxHeight = '100px'; inputContainer.style.opacity = '1'; inputContainer.style.marginTop = '0.5rem'; checkIcon.classList.remove('hidden'); } else { inputContainer.style.maxHeight = '0'; inputContainer.style.opacity = '0'; inputContainer.style.marginTop = '0'; checkIcon.classList.add('hidden'); } } });
            const numMatchesSelect = document.getElementById('post-num-matches'), mapLimitSpan = document.getElementById('map-selection-limit'), mapCountSpan = document.getElementById('map-selection-count'), mapContainer = document.getElementById('map-checkboxes-container');
            numMatchesSelect.addEventListener('change', () => { mapLimitSpan.textContent = numMatchesSelect.value; mapContainer.querySelectorAll('input:checked').forEach(cb => cb.checked = false); mapCountSpan.textContent = 0; });
            mapContainer.addEventListener('change', e => { const checkedCount = mapContainer.querySelectorAll('input:checked').length, limit = parseInt(numMatchesSelect.value, 10); if (checkedCount > limit) { e.target.checked = false; showModal('error', 'Limit Reached', `You can only select up to ${limit} map(s).`); } mapCountSpan.textContent = mapContainer.querySelectorAll('input:checked').length; });

            document.getElementById('create-post-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const form = e.target;
                handleFormSubmit(form, 'Creating Post...', async () => {
                    const editingPostId = document.getElementById('editing-post-id').value;
                    const postImageFile = document.getElementById('post-image-upload').files[0];
                    
                    const eventType = document.querySelector('input[name="event-type"]:checked').value;
                    const fees = { paid: 10, practice: 5 };
                    const creationFee = !editingPostId ? (fees[eventType] || 0) : 0;
                    
                    let imageInfo = {
                        url: editingPostId ? (window.dbData.posts[editingPostId]?.imageUrl || null) : null,
                        size: editingPostId ? (window.dbData.posts[editingPostId]?.imageSizeKB || 0) : 0
                    };
                    const oldSize = imageInfo.size;
    
                    if (postImageFile) {
                        const uploadResult = await uploadImage(postImageFile, 'post-images');
                        if (!uploadResult) {
                           throw new Error("Image upload failed.");
                        }
                        imageInfo.url = uploadResult.url;
                        imageInfo.size = uploadResult.size;
                    }
    
                    if (!imageInfo.url) {
                        throw new Error("Please upload a post image.");
                    }
                    const sizeDifference = imageInfo.size - oldSize;
                    
                    let winningPrizes = []; 
                    let totalPrizePool = 0;
                    let entryFee = parseInt(document.getElementById('post-entry-fee').value) || 0;
    
                    if (eventType === 'paid') {
                        document.querySelectorAll('#prize-options-container input[type="checkbox"]:checked').forEach(cb => { 
                            const amount = parseInt(cb.closest('.prize-checkbox').querySelector('.prize-input-container input').value); 
                            if(amount) { 
                                winningPrizes.push({ rank: cb.dataset.prizeName, prize: amount }); 
                                totalPrizePool += amount; 
                            } 
                        });
                    } else { entryFee = 0; winningPrizes = []; totalPrizePool = 0; }
                    
                    let totalDeductionFromLive = creationFee;
                    if (entryFee === 0 && totalPrizePool > 0 && !editingPostId) {
                         totalDeductionFromLive += totalPrizePool;
                    }
    
                    const sponsorLiveBalance = currentUserData.wallet.live || 0;
                    if (sponsorLiveBalance < totalDeductionFromLive) {
                         throw new Error(`Insufficient balance. You need ${totalDeductionFromLive.toFixed(2)} TK to create this event. Your balance is ${sponsorLiveBalance.toFixed(2)} TK.`);
                    }
                    
                    const matchDate = new Date(document.getElementById('post-match-date').value);
                    const [idh, idm] = document.getElementById('post-idpass-time').value.split(':');
                    const [sh, sm] = document.getElementById('post-matchstart-time').value.split(':');
                    const matchStartFullDate = new Date(matchDate.getFullYear(), matchDate.getMonth(), matchDate.getDate(), sh, sm).toISOString();
                    const fixedRule1 = "বুক করা স্লট রিফান্ড হবে না।";
                    const fixedRule2 = "যে টিম মেম্বারদের নিয়ে বুক করা হবে, তারা ছাড়া অন্য কেউ রুমে জয়েন করলে পুরো স্কোয়াডকে কিক দেওয়া হবে।";
                    const fixedRule3 = "ম্যাচ, টাকা বা পয়েন্ট নিয়ে কোনো সমস্যা হলে ৩ ঘণ্টার মধ্যে অ্যাডমিনের সাথে যোগাযোগ করতে হবে। এরপর কোনো অভিযোগ গ্রহণ করা হবে না।";
                    const customRules = Array.from(document.querySelectorAll('.rule-input')).map(input => input.value.trim()).filter(Boolean);
                    const rules = [fixedRule1, fixedRule2, fixedRule3, ...customRules];
    
                    const postData = { 
                        author: { name: currentUserData.name, avatar: currentUserData.avatar || DEFAULT_AVATAR }, authorId: auth.currentUser.uid, imageUrl: imageInfo.url, imageSizeKB: imageInfo.size, entryFee, matchDate: matchStartFullDate,
                        details: { eventType, eventName: document.getElementById('post-event-name').value, matchType: document.getElementById('post-battle-type').value, teamType: document.getElementById('post-team-type').value, numMatches: parseInt(numMatchesSelect.value), maps: Array.from(mapContainer.querySelectorAll('input:checked')).map(cb => cb.value), winningPrizes, rules, tags: document.getElementById('post-tags').value.split(',').map(tag => tag.trim()).filter(Boolean).slice(0, 5), idPassTime: document.getElementById('post-idpass-time').value, matchStartTime: document.getElementById('post-matchstart-time').value }
                    };
    
                    const updates = {};
                    if (editingPostId) {
                        const existingPost = window.dbData.posts[editingPostId];
                        const updatedPostData = { ...postData, slots: { ...existingPost.slots, total: parseInt(document.getElementById('post-total-slots').value) }, editedTimestamp: new Date().toISOString() };
                        if(getGoLiveStatus(updatedPostData).status === 'upcoming') updatedPostData.status = 'upcoming';
                        updates['/posts/' + editingPostId] = { ...existingPost, ...updatedPostData };
                    } else {
                        const postId = Date.now();
                        const newPost = { ...postData, id: postId, timestamp: new Date().toISOString(), slots: { booked: 0, total: parseInt(document.getElementById('post-total-slots').value) }, status: 'upcoming' };
                        updates['/posts/' + postId] = newPost;
                        if(totalDeductionFromLive > 0) {
                            updates[`/users/${auth.currentUser.uid}/wallet/live`] = sponsorLiveBalance - totalDeductionFromLive;
                        }
                        if (entryFee === 0 && totalPrizePool > 0) {
                             updates[`/users/${auth.currentUser.uid}/wallet/event`] = (currentUserData.wallet.event || 0) + totalPrizePool;
                        }
                    }
                    
                    await database.ref().update(updates);
                    updateTotalStorage(sizeDifference);
                    const action = editingPostId ? 'Updated' : 'Created';
                    showModal('success', `Post ${action}!`, `Your match post has been successfully ${action}.`, 'Awesome!', () => {
                        setActiveNavItem(document.getElementById('nav-manage-posts'));
                        navigateToPage('manage-posts-content');
                    });
                    resetPostForm();
                });
            });
            
            async function handleProfileImageUpload(e) {
                const file = e.target.files[0]; if (!file) return;
                const uploadResult = await uploadImage(file, 'avatars');
                if (uploadResult && uploadResult.url) {
                    document.getElementById('profile-page-avatar').src = uploadResult.url; document.getElementById('header-user-avatar').src = uploadResult.url;
                    const oldSize = currentUserData.avatarSizeKB || 0; const newSize = uploadResult.size; const sizeDifference = newSize - oldSize;
                    const updates = {};
                    updates['/users/' + auth.currentUser.uid + '/avatar'] = uploadResult.url; updates['/users/' + auth.currentUser.uid + '/avatarSizeKB'] = newSize;
                    database.ref().update(updates).then(() => { updateTotalStorage(sizeDifference); showModal('success', 'Profile Updated', 'Your new profile picture has been saved.'); });
                }
            }

            function resetPostForm() { 
                document.getElementById('create-post-form').reset(); 
                document.getElementById('editing-post-id').value = ''; 
                postImagePreview.classList.add('hidden'); 
                postImagePreview.src = ''; 
                postImagePlaceholder.classList.remove('hidden'); 
                const submitBtn = document.getElementById('create-post-submit-btn'); 
                submitBtn.textContent = submitBtn.dataset.createText; 
                mapLimitSpan.textContent = 1; 
                mapCountSpan.textContent = 0; 
                postImageUploadInput.required = true; 
                document.getElementById('rules-container').innerHTML = `
                    <div class="relative">
                        <p class="form-input bg-gray-800 text-gray-400 overflow-x-auto whitespace-nowrap no-scrollbar pr-10">বুক করা স্লট রিফান্ড হবে না।</p>
                        <i class="fa-solid fa-lock absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                    </div>
                    <div class="relative">
                        <p class="form-input bg-gray-800 text-gray-400 overflow-x-auto whitespace-nowrap no-scrollbar pr-10">যে টিম মেম্বারদের নিয়ে বুক করা হবে, তারা ছাড়া অন্য কেউ রুমে জয়েন করলে পুরো স্কোয়াডকে কিক দেওয়া হবে।</p>
                        <i class="fa-solid fa-lock absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                    </div>
                    <div class="relative">
                        <p class="form-input bg-gray-800 text-gray-400 overflow-x-auto whitespace-nowrap no-scrollbar pr-10">ম্যাচ, টাকা বা পয়েন্ট নিয়ে কোনো সমস্যা হলে ৩ ঘণ্টার মধ্যে অ্যাডমিনের সাথে যোগাযোগ করতে হবে। এরপর কোনো অভিযোগ গ্রহণ করা হবে না।</p>
                        <i class="fa-solid fa-lock absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                    </div>`; 
                updatePrizesAndSlots(); 
            }
           
            const navItems = document.querySelectorAll('.nav-item'), navIndicator = document.getElementById('nav-indicator'); const allHeaders = document.querySelectorAll('header'); const transitionOverlay = document.getElementById('page-transition-overlay');
            const updateNavIndicator = (activeItem) => { if (activeItem) { navIndicator.style.width = `${activeItem.offsetWidth}px`; navIndicator.style.left = `${activeItem.offsetLeft}px`; } else { navIndicator.style.width = '0px'; }};
            const setActiveNavItem = (itemToActivate) => { navItems.forEach(i => i.classList.remove('active')); if(itemToActivate) { itemToActivate.classList.add('active'); } setTimeout(() => updateNavIndicator(itemToActivate), 400); };
            
            const navigateToPage = (pageId, isInitial = false) => {
                const showNewPage = () => {
                     document.querySelectorAll('.dashboard-page').forEach(p => p.classList.add('hidden'));
                     const newPage = document.getElementById(pageId); if (newPage) newPage.classList.remove('hidden');
                     allHeaders.forEach(h => h.classList.add('hidden'));
                     switch(pageId) { 
                        case 'wallet-content': case 'profile-content': case 'mailbox-content': document.getElementById('main-header').classList.remove('hidden'); break; 
                        case 'add-post-content': document.getElementById('add-post-header').classList.remove('hidden'); break; 
                        case 'manage-posts-content': document.getElementById('manage-posts-header').classList.remove('hidden'); break; 
                        case 'history-content': document.getElementById('history-header').classList.remove('hidden'); break;
                        case 'kyc-content': document.getElementById('kyc-header').classList.remove('hidden'); break;
                        case 'statement-content': document.getElementById('statement-header').classList.remove('hidden'); break;
                        case 'feedback-content': document.getElementById('feedback-header').classList.remove('hidden'); break;
                        case 'account-settings-content': document.getElementById('account-settings-header').classList.remove('hidden'); break;
                        default: document.getElementById('main-header').classList.remove('hidden');
                    }
                     if (pageId === 'add-post-content' && !document.getElementById('editing-post-id').value) { resetPostForm(); }
                     
                     if(pageId === 'manage-posts-content') renderManagePostsPage();
                     if(pageId === 'profile-content') { calculateAndDisplayReputation(); renderProOrganizerProgress(); }
                     if(pageId === 'mailbox-content') renderMailbox();
                     if(pageId === 'history-content') renderHistoryPage();
                     if(pageId === 'kyc-content') renderKycPage();
                     if(pageId === 'statement-content') renderEventsAndEarningsPage();
                     if(pageId === 'feedback-content') renderFeedbackPage();
                }
                if (isInitial) { 
                    showNewPage(); 
                } else { 
                    transitionOverlay.classList.add('active'); 
                    setTimeout(() => { 
                        showNewPage(); 
                        setTimeout(() => transitionOverlay.classList.remove('active'), 50); 
                    }, 200); 
                }
            }
            navItems.forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); setActiveNavItem(item); const pageId = item.id.replace('nav-', '') + '-content'; navigateToPage(pageId); }));
            document.getElementById('wallet-button').addEventListener('click', () => { navigateToPage('wallet-content'); setActiveNavItem(document.getElementById('nav-wallet')); }); 
            document.getElementById('header-create-post-btn').addEventListener('click', () => { 
                resetPostForm(); 
                navigateToPage('add-post-content'); 
                setActiveNavItem(null); 
            });
            document.getElementById('feedback-button').addEventListener('click', () => navigateToPage('feedback-content'));
            document.getElementById('history-button').addEventListener('click', () => navigateToPage('history-content'));
            document.getElementById('kyc-button').addEventListener('click', () => navigateToPage('kyc-content'));
            document.getElementById('statement-button').addEventListener('click', () => navigateToPage('statement-content'));
            document.getElementById('account-settings-button').addEventListener('click', () => navigateToPage('account-settings-content'));
            document.getElementById('back-to-profile-btn').addEventListener('click', () => navigateToPage('profile-content'));
            document.querySelectorAll('.back-to-profile-from-subpage').forEach(btn => {
                btn.addEventListener('click', () => navigateToPage('profile-content'));
            });

            function getGoLiveStatus(post, now = new Date()) { const matchDate = new Date(post.matchDate); const [h, m] = post.details.idPassTime.split(':'); const idPassTime = new Date(matchDate.getFullYear(), matchDate.getMonth(), matchDate.getDate(), h, m).getTime(); const thirtyMinBefore = idPassTime - (30 * 60 * 1000); const nowTime = now.getTime(); let status = 'upcoming'; if (nowTime >= idPassTime) { status = 'auto-live'; } else if (nowTime >= thirtyMinBefore) { status = 'can-go-live'; } return { status, idPassTime }; }

            function renderManagePostsPage() {
                const myPosts = Object.values(window.dbData.posts || {}).filter(p => p.authorId === auth.currentUser.uid).sort((a,b) => b.timestamp - a.timestamp);
                const postContainer = document.getElementById('event-post-container'); const liveContainer = document.getElementById('event-live-container');
                postContainer.innerHTML = ''; liveContainer.innerHTML = '';
                myPosts.forEach(post => { 
                    if (post.status.startsWith('live')) { liveContainer.innerHTML += createManagePostCardHTML(post); } 
                    else if (post.status === 'upcoming') { postContainer.innerHTML += createManagePostCardHTML(post); }
                });
                if(!postContainer.innerHTML) postContainer.innerHTML = '<p class="text-gray-500 p-4 text-center">No upcoming events found.</p>'; if(!liveContainer.innerHTML) liveContainer.innerHTML = '<p class="text-gray-500 p-4 text-center">No events are live right now.</p>';
                if (!document.querySelector('.manage-posts-tab.active-tab')) { setupTabs('manage-posts-content', '.manage-posts-tab', '.tab-content-section'); }
            }
            
             function createManagePostCardHTML(post) { 
                let buttonsHTML = '', statusText = 'Upcoming', statusClass = 'upcoming';
                const goLiveStatus = getGoLiveStatus(post).status;

                if (post.status === 'cancelled') { statusText = `Cancelled ${post.cancellationReason === 'auto' ? '(Auto)' : ''}`; statusClass = 'cancelled'; } 
                else if (post.status === 'completed') { statusText = 'Completed'; statusClass = 'completed'; } 
                else if (post.status.startsWith('live')) { statusText = 'Live'; statusClass = 'live'; }
                
                if (post.status === 'upcoming') {
                    buttonsHTML += `<div class="flex items-center justify-between gap-2 mt-3">
                                        <button class="move-to-live-btn text-white bg-yellow-600 hover:bg-yellow-700 py-2 px-3 rounded-lg text-sm font-bold flex-1">Go Live</button>
                                        <div class="flex items-center gap-2">
                                            <button class="edit-post-btn text-white bg-blue-600 hover:bg-blue-700 w-9 h-9 rounded-full flex items-center justify-center"><i class="fa-solid fa-pencil"></i></button>
                                            <button class="delete-post-btn text-white bg-red-600 hover:bg-red-700 w-9 h-9 rounded-full flex items-center justify-center"><i class="fa-solid fa-trash"></i></button>
                                        </div>
                                    </div>`;
                } else if (post.status === 'completed' || post.status === 'cancelled') {
                    buttonsHTML = `<div class="mt-3"><button class="w-full py-2 rounded-lg text-sm font-bold bg-gray-600 cursor-default">View Details</button></div>`;
                }
                else {
                    buttonsHTML = `<div class="mt-3"><button class="w-full py-2 rounded-lg text-sm font-bold action-button manage-live-btn">Manage Live</button></div>`;
                }

                return `<div class="manage-post-card rounded-2xl overflow-hidden shadow-lg flex" data-post-id="${post.id}">
                            <div class="w-1/3 relative">
                                <img src="${post.imageUrl}" class="w-full h-full object-cover cursor-pointer">
                                <span class="absolute top-2 left-2 status-tag ${statusClass}">${statusText}</span>
                            </div>
                            <div class="w-2/3 p-3 md:p-4 flex flex-col justify-between">
                                <div>
                                    <p class="font-bold text-white text-md md:text-lg truncate">${post.details.eventName}</p>
                                    <div class="space-y-1 text-xs text-gray-300 mt-2">
                                        <span class="flex items-center gap-2 truncate"><i class="fa-solid fa-users text-green-400 w-4 text-center"></i> ${post.slots.booked || 0}/${post.slots.total} Slots</span>
                                        <span class="flex items-center gap-2 truncate"><i class="fa-solid fa-tags text-green-400 w-4 text-center"></i> ${post.entryFee} TK</span>
                                        <span class="flex items-center gap-2 truncate"><i class="fa-solid fa-calendar-day text-green-400 w-4 text-center"></i> ${new Date(post.matchDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' })} @ ${post.details.matchStartTime}</span>
                                    </div>
                                </div>
                                ${buttonsHTML}
                            </div>
                        </div>`;
            }

            document.getElementById('dashboard-screen').addEventListener('click', (e) => {
                const card = e.target.closest('[data-post-id]');
                if (!card) return;
                const postId = card.dataset.postId;
                const post = window.dbData.posts[postId];
                if (!post) return;

                if (e.target.closest('.edit-post-btn')) { handleEditPost(postId); }
                else if (e.target.closest('.delete-post-btn')) { handleDeletePost(postId); }
                else if (e.target.closest('.move-to-live-btn')) { handleMoveToLive(postId); }
                else if (e.target.closest('.manage-live-btn')) { renderSponsorLiveView(postId); }
                else if (e.target.closest('img')) { showParticipantList(postId); }
                else { 
                    if (post.status === 'completed' || post.status === 'cancelled') {
                        renderSponsorHistoryView(postId);
                    } else if (post.status.startsWith('live')) {
                        renderSponsorLiveView(postId);
                    } else if (post.status === 'upcoming') {
                        showParticipantList(postId);
                    }
                }
            });

            function showIdPassModal(postId) { document.getElementById('idpass-post-id').value = postId; screens.idpass.classList.remove('hidden'); }
            document.getElementById('close-idpass-modal').addEventListener('click', () => screens.idpass.classList.add('hidden'));
            document.getElementById('id-pass-form').addEventListener('submit', (e) => { e.preventDefault(); const postId = document.getElementById('idpass-post-id').value; const updates = {}; updates[`/posts/${postId}/roomId`] = document.getElementById('room-id-input').value; updates[`/posts/${postId}/roomPass`] = document.getElementById('room-pass-input').value; updates[`/posts/${postId}/status`] = 'live_idpass_set'; database.ref().update(updates).then(() => { screens.idpass.classList.add('hidden'); e.target.reset(); }); });
            
            async function handleCancelEvent(postId, isAuto = false, isPunishment = false) {
                const post = window.dbData.posts[postId]; if (!post || post.status === 'cancelled') return; 
                const updates = {}; let totalRefund = 0; const mailId = Date.now();
                
                Object.values(post.participants || {}).forEach(p => { 
                    const user = window.dbData.users[p.userId]; 
                    if (user && post.entryFee > 0) { 
                        updates[`/users/${p.userId}/wallet/live`] = (user.wallet.live || 0) + post.entryFee;
                        updates[`/users/${p.userId}/mailbox/${mailId}`] = {
                            id: mailId, postId: parseInt(postId), type: 'refund', read: false,
                            subject: 'Match Cancelled & Refunded',
                            body: { reason: `The match "${post.details.eventName}" has been cancelled. Your entry fee of ${post.entryFee} TK has been refunded to your live wallet.`, refunded: true },
                            timestamp: new Date().toISOString()
                        };
                        totalRefund += post.entryFee; 
                    } 
                }); 

                if (currentUserData) { 
                    updates[`/users/${auth.currentUser.uid}/wallet/event`] = (currentUserData.wallet.event || 0) - totalRefund; 
                } 
                
                updates[`/posts/${postId}/status`] = 'cancelled'; 
                updates[`/posts/${postId}/cancelledAt`] = new Date().toISOString();
                if(isAuto) updates[`/posts/${postId}/cancellationReason`] = 'auto'; 

                if (isPunishment) {
                    updates[`/users/${auth.currentUser.uid}/wallet/live`] = (currentUserData.wallet.live || 0) - 50;
                    const punishmentMailId = Date.now() + 1;
                     updates[`/users/${auth.currentUser.uid}/mailbox/${punishmentMailId}`] = {
                        id: punishmentMailId, type: 'punishment', read: false,
                        subject: 'Penalty for Match Cancellation',
                        body: { reason: `আপনার ম্যাচটি নির্ধারিত সময়ে শুরু না করতে পারায় এবং এমন ঘটনা ৩ বার হওয়ায় আপনার লাইভ ওয়ালেট থেকে ৫০ টাকা কেটে নেওয়া হয়েছে।` },
                        timestamp: new Date().toISOString()
                    };
                }
                
                await database.ref().update(updates);
                if(!isAuto) showModal('success', 'Event Cancelled', 'All participants have been refunded and notified.'); 
            }

            function handleMatchStart(postId) { database.ref(`/posts/${postId}/status`).set('live_match_running'); }
            
            async function handleMoveToLive(postId) {
                // MODIFIED: Changed popup type to 'confirm' to show icon instead of Lottie
                showCustomModal({
                    type: 'confirm',
                    title: 'Go Live?',
                    message: 'আপনি কি নিশ্চিত যে এই ম্যাচটি লাইভ করতে চান?',
                    primaryButton: {
                        text: 'হ্যাঁ, লাইভ করুন',
                        onClick: async () => {
                            const post = window.dbData.posts[postId];
                            if (!post) return;

                            if (post.details.eventType === 'paid') {
                                let totalPrizePool = 0;
                                (post.details.winningPrizes || []).forEach(p => totalPrizePool += p.prize);

                                const currentEventBalance = (post.slots.booked || 0) * post.entryFee;
                                const shortfall = totalPrizePool - currentEventBalance;

                                if (shortfall > 0) {
                                    const sponsorLiveBalance = currentUserData.wallet.live || 0;
                                    if (sponsorLiveBalance < shortfall) {
                                        showModal('error', 'Insufficient Funds', `You need an additional ${shortfall.toFixed(2)} TK in your Live Balance to cover the prize pool. Please deposit funds or cancel the match.`);
                                        return;
                                    }
                                    
                                    const updates = {};
                                    updates[`/users/${auth.currentUser.uid}/wallet/live`] = sponsorLiveBalance - shortfall;
                                    updates[`/users/${auth.currentUser.uid}/wallet/event`] = (currentUserData.wallet.event || 0) + shortfall;
                                    updates[`/posts/${postId}/status`] = 'live_idpass_pending';
                                    
                                    await database.ref().update(updates);
                                    showModal('success', 'Funds Transferred', `${shortfall.toFixed(2)} TK has been moved from your Live to Event balance to cover the prize pool. The match is now ready to go live.`);
                                } else {
                                    await database.ref(`/posts/${postId}/status`).set('live_idpass_pending');
                                }
                            } else {
                                await database.ref(`/posts/${postId}/status`).set('live_idpass_pending');
                            }
                        }
                    },
                    secondaryButton: { text: 'না' }
                });
            }
            
            function showParticipantList(postId) { 
                const screen = document.getElementById('participant-list-screen');
                screen.dataset.postId = postId;
                const post = window.dbData.posts[postId]; if (!post) return; 
                
                const isLive = post.status.startsWith('live');

                const participantsHTML = Object.values(post.participants || {}).map(p => { 
                    const user = window.dbData.users[p.userId];
                    const team = user?.team; 
                    if (!user) return ''; 
                    const teamName = post.details.teamType.toLowerCase() === 'solo' ? p.players[0].name : (team ? team.name : 'Unknown Team');
                    
                    const kickButtonHTML = isLive 
                        ? `<button class="bg-yellow-800 text-yellow-500 cursor-not-allowed px-3 py-1 text-xs rounded-md" disabled>Kick</button>`
                        : `<button class="kick-team-btn bg-yellow-600 hover:bg-yellow-700 px-3 py-1 text-xs rounded-md" data-user-id="${p.userId}" data-post-id="${postId}">Kick</button>`;

                    return `<div class="bg-[#2a2a2a] rounded-lg p-3 flex justify-between items-center">
                                <span>#${p.slotNumber} ${teamName}</span>
                                <div class="flex gap-2">
                                    ${kickButtonHTML}
                                    <button class="ban-team-btn bg-red-600 hover:bg-red-700 px-3 py-1 text-xs rounded-md" data-user-id="${p.userId}" data-post-id="${postId}">Ban</button>
                                </div>
                            </div>`; 
                }).join(''); 
                
                const content = document.getElementById('participant-list-content'); 
                content.innerHTML = `<div class="sticky top-0 bg-[#121212] py-4 flex justify-between items-center"><h2 class="text-2xl font-bold">${post.details.eventName} - Teams</h2><button id="close-participants-btn" class="text-gray-400 text-3xl">&times;</button></div><p class="text-lg mb-2">Slots Filled: <span class="font-bold">${Object.keys(post.participants || {}).length}/${post.slots.total}</span></p><div class="space-y-2 participant-list">${Object.keys(post.participants || {}).length > 0 ? participantsHTML : '<p class="text-gray-500 p-4">No teams have booked yet.</p>'}</div>`; 
                screens.participants.classList.remove('hidden'); 
                content.querySelector('#close-participants-btn').addEventListener('click', () => {screens.participants.classList.add('hidden'); delete screen.dataset.postId; }); 
                content.querySelectorAll('.ban-team-btn').forEach(btn => btn.addEventListener('click', e => { showBanTeamModal(e.target.dataset.postId, e.target.dataset.userId, false); }));
                content.querySelectorAll('.kick-team-btn').forEach(btn => btn.addEventListener('click', e => { handleKickTeam(e.target.dataset.postId, e.target.dataset.userId); }));
            }
            
            function handleDeletePost(postId) {
                showCustomModal({
                    type: 'error',
                    title: 'Confirm Deletion',
                    message: 'This will permanently delete the event post. This action cannot be undone and will not refund players if they have already booked.',
                    primaryButton: {
                        text: 'Yes, Delete Post',
                        onClick: async () => {
                            try {
                                await database.ref(`/posts/${postId}`).remove();
                                showModal('success', 'Post Deleted', 'The event post has been permanently removed.');
                            } catch (err) {
                                handleFirebaseError(err);
                            }
                        }
                    },
                    secondaryButton: { text: 'Cancel' }
                });
            }

            function handleEditPost(postId) {
                const postToEdit = window.dbData.posts[postId];
                if (!postToEdit) { console.error("Post not found for editing:", postId); return; }
                resetPostForm();
                try {
                    document.getElementById('editing-post-id').value = postId;
                    document.querySelector(`input[name="event-type"][value="${postToEdit.details.eventType || 'paid'}"]`).click();
                    document.getElementById('post-event-name').value = postToEdit.details.eventName || '';
                    document.getElementById('post-battle-type').value = postToEdit.details.matchType || 'Battle Royal';
                    document.getElementById('post-team-type').value = postToEdit.details.teamType || 'Squad';
                    updatePrizesAndSlots();
                    document.getElementById('post-entry-fee').value = postToEdit.entryFee;
                    const matchDate = new Date(postToEdit.matchDate);
                    if (!isNaN(matchDate)) { document.getElementById('post-match-date').value = matchDate.toISOString().split('T')[0]; }
                    document.getElementById('post-idpass-time').value = postToEdit.details.idPassTime || '';
                    document.getElementById('post-matchstart-time').value = postToEdit.details.matchStartTime || '';
                    document.getElementById('post-num-matches').value = postToEdit.details.numMatches || 1;
                    
                    const rulesContainer = document.getElementById('rules-container');
                    rulesContainer.innerHTML = `<div class="relative"> <p class="form-input bg-gray-800 text-gray-400 overflow-x-auto whitespace-nowrap no-scrollbar pr-10">বুক করা স্লট রিফান্ড হবে না।</p> <i class="fa-solid fa-lock absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"></i> </div><div class="relative"> <p class="form-input bg-gray-800 text-gray-400 overflow-x-auto whitespace-nowrap no-scrollbar pr-10">যে টিম মেম্বারদের নিয়ে বুক করা হবে, তারা ছাড়া অন্য কেউ রুমে জয়েন করলে পুরো স্কোয়াডকে কিক দেওয়া হবে।</p> <i class="fa-solid fa-lock absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"></i> </div><div class="relative"> <p class="form-input bg-gray-800 text-gray-400 overflow-x-auto whitespace-nowrap no-scrollbar pr-10">ম্যাচ, টাকা বা পয়েন্ট নিয়ে কোনো সমস্যা হলে ৩ ঘণ্টার মধ্যে অ্যাডমিনের সাথে যোগাযোগ করতে হবে। এরপর কোনো অভিযোগ গ্রহণ করা হবে না।</p> <i class="fa-solid fa-lock absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"></i> </div>`;
                    const customRules = (postToEdit.details.rules || []).slice(3);
                    customRules.forEach((rule, index) => {
                        const ruleCount = index + 4;
                        const ruleWrapper = document.createElement('div');
                        ruleWrapper.className = 'relative flex items-center custom-rule';
                        const newRuleInput = document.createElement('input');
                        newRuleInput.type = 'text'; newRuleInput.className = 'form-input rule-input pr-10'; newRuleInput.placeholder = `নিয়ম #${ruleCount}`; newRuleInput.value = rule; newRuleInput.required = true;
                        const deleteBtn = document.createElement('button');
                        deleteBtn.type = 'button'; deleteBtn.className = 'absolute right-3 text-red-500 hover:text-red-400 focus:outline-none'; deleteBtn.innerHTML = '<i class="fa-solid fa-trash-can"></i>'; deleteBtn.onclick = () => ruleWrapper.remove();
                        ruleWrapper.appendChild(newRuleInput); ruleWrapper.appendChild(deleteBtn); rulesContainer.appendChild(ruleWrapper);
                    });

                    document.getElementById('post-tags').value = (postToEdit.details.tags || []).join(', ');
                    postImagePreview.src = postToEdit.imageUrl;
                    postImagePreview.classList.remove('hidden'); postImagePlaceholder.classList.add('hidden');
                    postImageUploadInput.required = false;
                    mapLimitSpan.textContent = postToEdit.details.numMatches || 1;
                    const postMaps = postToEdit.details.maps || [];
                    mapContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = postMaps.includes(cb.value); });
                    mapCountSpan.textContent = mapContainer.querySelectorAll('input:checked').length;

                    if(postToEdit.details.eventType !== 'practice') {
                        (postToEdit.details.winningPrizes || []).forEach(prizeData => {
                            const cb = prizeContainer.querySelector(`input[data-prize-name="${prizeData.rank}"]`);
                            if (cb) {
                                cb.checked = true;
                                const prizeCheckboxDiv = cb.closest('.prize-checkbox');
                                const inputContainer = prizeCheckboxDiv.querySelector('.prize-input-container');
                                inputContainer.style.maxHeight = '100px'; inputContainer.style.opacity = '1'; inputContainer.style.marginTop = '0.5rem';
                                inputContainer.querySelector('input').value = prizeData.prize;
                                prizeCheckboxDiv.querySelector('.fa-check').classList.remove('hidden');
                            }
                        });
                    }
                    const submitBtn = document.getElementById('create-post-submit-btn');
                    submitBtn.textContent = submitBtn.dataset.editText;
                    navigateToPage('add-post-content');
                    setActiveNavItem(null);
                } catch (error) {
                    console.error("Error populating form for edit:", error);
                    showModal('error', 'Could Not Edit', 'An error occurred while loading the post data for editing.');
                }
            }

            function setupTabs(containerId, buttonClass, sectionClass) {
                const container = document.getElementById(containerId); if (!container) return;
                const tabs = container.querySelectorAll(buttonClass); const sections = container.querySelectorAll(sectionClass); if (tabs.length === 0) return;
                let activeTab = container.querySelector(`${buttonClass}.active-tab`);
                if (!activeTab && tabs[0]) {
                    activeTab = tabs[0];
                    tabs.forEach(t => t.classList.remove('active-tab'));
                    sections.forEach(s => s.classList.remove('active-section'));
                    if(activeTab) {
                       activeTab.classList.add('active-tab');
                       const targetSection = document.getElementById(activeTab.dataset.target);
                       if (targetSection) targetSection.classList.add('active-section');
                    }
                }
                tabs.forEach(tab => { tab.addEventListener('click', () => { if (tab.classList.contains('active-tab')) return; tabs.forEach(t => t.classList.remove('active-tab')); sections.forEach(s => s.classList.remove('active-section')); tab.classList.add('active-tab'); const targetSection = document.getElementById(tab.dataset.target); if (targetSection) targetSection.classList.add('active-section'); }); });
            }
            
            function checkTimedEvents() {
                const now = new Date().getTime();
                const posts = Object.values(window.dbData.posts || {});
                posts.forEach(async (post) => {
                    if (post.status === 'upcoming' && !post.roomId) {
                        const matchDate = new Date(post.matchDate);
                        const [h,m] = post.details.idPassTime.split(':');
                        const idPassTime = new Date(matchDate.getFullYear(), matchDate.getMonth(), matchDate.getDate(), h, m).getTime();
                        const deadline = idPassTime + (10 * 60 * 1000); // 10 minute grace period
                        
                        if (now > deadline) {
                            const sponsorRef = database.ref(`users/${post.authorId}/analytics/autoCancelCount`);
                            const snapshot = await sponsorRef.once('value');
                            const currentCount = snapshot.val() || 0;
                            const newCount = currentCount + 1;
                            
                            let isPunishment = false;
                            if (newCount > 0 && newCount % 3 === 0) {
                                isPunishment = true;
                            }
                            
                            await sponsorRef.set(newCount);
                            handleCancelEvent(post.id, true, isPunishment);
                            return;
                        }
                    }
                });
            }
            setInterval(checkTimedEvents, 30000); // Check every 30 seconds

            // NEW: Global timer to update all dynamic time elements
            function updateAllTimers() {
                document.querySelectorAll('[data-countdown-to]').forEach(el => {
                    const endTime = parseInt(el.dataset.countdownTo, 10);
                    const now = Date.now();
                    const remaining = endTime - now;
                    if (remaining > 0) {
                        const hours = Math.floor(remaining / (1000 * 60 * 60));
                        const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                        el.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    } else {
                        el.textContent = "00:00:00";
                        // This might be where we trigger the button to show, handled by the main render function
                    }
                });
            }


            const lightbox = document.getElementById('image-lightbox'); const lightboxImg = document.getElementById('lightbox-img');
            function showLightbox(src) { if(src) { lightboxImg.src = src; lightbox.classList.remove('hidden'); } }
            function hideLightbox() { lightbox.classList.add('hidden'); }

            function calculatePoints(kills, position) { const pp = { 1: 12, 2: 9, 3: 8, 4: 7, 5: 6, 6: 5, 7: 4, 8: 3, 9: 2, 10: 1, 11: 0, 12: 0 }; return (parseInt(kills) || 0) + (pp[parseInt(position)] || 0); }
            
            function renderSponsorHistoryView(postId) {
                const post = window.dbData.posts[postId];
                if (!post) return;
                const content = document.getElementById('sponsor-live-view-content');
                screens.sponsorLive.dataset.postId = postId;
                
                content.innerHTML = `
                    <div class="sticky top-0 bg-[#121212]/80 backdrop-blur-md py-4 px-4 flex justify-between items-center z-10">
                        <h2 class="text-2xl font-bold">${post.details.eventName}</h2>
                        <button id="close-sponsor-view-btn" class="text-gray-400 text-3xl">&times;</button>
                    </div>
                    <div class="px-4 pb-4">
                        <div id="sponsor-leaderboard-content-history"></div>
                    </div>
                `;
            
                renderSponsorLeaderboard(postId, 'sponsor-leaderboard-content-history', false); // Render read-only leaderboard
                screens.sponsorLive.classList.remove('hidden');
            
                content.querySelector('#close-sponsor-view-btn').addEventListener('click', () => {
                    screens.sponsorLive.classList.add('hidden');
                    delete screens.sponsorLive.dataset.postId;
                });
            }
            
            function handleLeaderboardClick(e) {
                const editBtn = e.target.closest('.edit-points-btn');
                if (editBtn) {
                    handleEditPoints(editBtn.dataset.postId, editBtn.dataset.userId);
                    return;
                }
                const row = e.target.closest('.leaderboard-row');
                if (row) {
                    const details = row.nextElementSibling;
                    if (details && details.classList.contains('team-members-details')) {
                        row.closest('.space-y-2').querySelectorAll('.team-members-details').forEach(d => {
                            if (d !== details) d.classList.add('hidden');
                        });
                        details.classList.toggle('hidden');
                    }
                }
            }
            
            function renderSponsorLiveView(postId, activeTabTarget = 'sponsor-manage-content') { const post = window.dbData.posts[postId]; if (!post) return; const content = document.getElementById('sponsor-live-view-content'); screens.sponsorLive.dataset.postId = postId; let bottomButtons = ''; if (post.status !== 'completed' && post.status !== 'cancelled') { bottomButtons = `<div class="fixed bottom-0 left-0 w-full p-4 bg-[#1e1e1e] border-t border-gray-700 z-20"><button id="send-prizes-btn" class="w-full py-3 action-button rounded-lg text-lg">Send Prizes & Finalize</button></div>`; } content.innerHTML = `<div class="sticky top-0 bg-[#121212]/80 backdrop-blur-md py-4 px-4 flex justify-between items-center z-10"><h2 class="text-2xl font-bold">${post.details.eventName}</h2><button id="close-sponsor-view-btn" class="text-gray-400 text-3xl">&times;</button></div><div class="flex gap-2 mb-4 px-4"><button class="tab-button sponsor-view-tab" data-target="sponsor-manage-content">Manage</button><button class="tab-button sponsor-view-tab" data-target="sponsor-teams-content">Submissions</button><button class="tab-button sponsor-view-tab" data-target="sponsor-participants-content">Participants</button><button class="tab-button sponsor-view-tab" data-target="sponsor-leaderboard-content">Leaderboard</button></div><div class="px-4 pb-24 overflow-y-auto h-[calc(100%-120px)] no-scrollbar"><div id="sponsor-manage-content" class="tab-content-section"></div><div id="sponsor-teams-content" class="tab-content-section"></div><div id="sponsor-participants-content" class="tab-content-section"></div><div id="sponsor-leaderboard-content" class="tab-content-section"></div></div>${bottomButtons}`; renderSponsorManageTab(postId); renderSponsorTeamsTab(postId); renderSponsorParticipantsTab(postId); renderSponsorLeaderboard(postId, 'sponsor-leaderboard-content', true); screens.sponsorLive.classList.remove('hidden'); content.querySelector('#close-sponsor-view-btn').addEventListener('click', () => { screens.sponsorLive.classList.add('hidden'); delete screens.sponsorLive.dataset.postId; }); setupTabs('sponsor-live-view-content', '.sponsor-view-tab', '.tab-content-section'); if(activeTabTarget) { const desiredTab = content.querySelector(`.sponsor-view-tab[data-target="${activeTabTarget}"]`); if (desiredTab && !desiredTab.classList.contains('active-tab')) { content.querySelectorAll('.sponsor-view-tab').forEach(t => t.classList.remove('active-tab')); content.querySelectorAll('.tab-content-section').forEach(s => s.classList.remove('active-section')); desiredTab.classList.add('active-tab'); document.getElementById(activeTabTarget)?.classList.add('active-section'); } } if(post.status !== 'completed' && post.status !== 'cancelled') { const sendPrizesBtn = content.querySelector('#send-prizes-btn'); if(sendPrizesBtn) { sendPrizesBtn.addEventListener('click', () => handleSendPrizes(postId)); checkFinalizeButtonState(postId); } } }
            function renderSponsorLeaderboard(postId, containerId = 'sponsor-leaderboard-content', allowEdit = true) { const post = window.dbData.posts[postId]; const container = document.getElementById(containerId); if (!container) return; const resultsSource = post['approvedResults'] || {}; const leaderboardData = Object.values(post.participants || {}).map(p => { const user = window.dbData.users[p.userId]; if (!user) return null; const team = user.team; const name = post.details.teamType.toLowerCase() === 'solo' ? p.players[0].name : (team ? team.name : 'Unknown Team'); const logo = post.details.teamType.toLowerCase() === 'solo' ? user.avatar : (team?.logo || DEFAULT_AVATAR); let totalPoints = 0, totalKills = 0, totalPP = 0, isEdited = false; if (resultsSource[p.userId]) { Object.values(resultsSource[p.userId]).forEach(mapResult => { if(mapResult.edited) isEdited = true; totalPoints += calculatePoints(mapResult.kills, mapResult.position); totalKills += parseInt(mapResult.kills) || 0; totalPP += calculatePoints(0, mapResult.position); }); } return { name, logo, userId: p.userId, totalPoints, totalKills, totalPP, isEdited }; }).filter(Boolean).sort((a, b) => b.totalPoints - a.totalPoints); const getRankClass = (index) => { if (index === 0) return 'bg-yellow-500/20 border-yellow-400'; if (index === 1) return 'bg-gray-400/20 border-gray-300'; if (index === 2) return 'bg-yellow-800/20 border-yellow-700'; return 'bg-[#1e1e1e] border-gray-800'; }; const leaderboardHTML = leaderboardData.map((team, index) => { const teamData = window.dbData.users[team.userId]?.team; let membersHTML = '<p class="text-xs text-gray-500">Team data not available.</p>'; if (teamData && teamData.members) { membersHTML = teamData.members.map((member, idx) => `<li class="flex justify-between text-xs py-1 px-2 rounded ${idx === 0 ? 'bg-yellow-500/20' : ''}"><span>${idx === 0 ? '👑' : ''} ${member.name}</span><span class="text-gray-400">${member.uid}</span></li>`).join(''); } const editButtonHTML = allowEdit ? `<div class="col-span-1 text-center"><button class="edit-points-btn text-blue-400 hover:text-blue-300" data-post-id="${postId}" data-user-id="${team.userId}"><i class="fa-solid fa-pencil"></i></button></div>` : '<div class="col-span-1"></div>'; return `<div class="leaderboard-item-wrapper rounded-lg border ${getRankClass(index)}"><div class="leaderboard-row grid grid-cols-12 items-center p-2 text-sm cursor-pointer" data-user-id="${team.userId}"><span class="font-bold col-span-1 text-center text-lg">#${index + 1}</span><img src="${team.logo}" class="w-8 h-8 rounded-full col-span-1 object-cover"><p class="font-semibold col-span-3 ml-2 truncate">${team.name}</p><p class="text-center col-span-2">${team.totalKills}</p><p class="text-center col-span-2">${team.totalPP}</p><p class="font-bold text-green-400 text-center col-span-2">${team.totalPoints}</p>${editButtonHTML}</div><div class="team-members-details hidden p-3 bg-gray-900/50 border-t border-gray-700"><h5 class="font-bold text-sm mb-2 text-green-300">Team Roster</h5><ul class="space-y-1">${membersHTML}</ul></div></div>` }).join(''); const headerEditCol = allowEdit ? '<span class="text-center col-span-1">EDIT</span>' : '<span class="col-span-1"></span>'; container.innerHTML = `<h3 class="text-xl font-bold mb-3">Leaderboard</h3><div class="grid grid-cols-12 text-xs text-gray-400 font-bold p-2"><span class="col-span-1 text-center">POS</span><span class="col-span-4 ml-2">TEAM</span><span class="text-center col-span-2">KP</span><span class="text-center col-span-2">PP</span><span class="text-center col-span-2">TOTAL</span>${headerEditCol}</div><div class="space-y-2">${leaderboardHTML || '<p class="text-center text-gray-500 p-4">No approved results yet.</p>'}</div>`; if (allowEdit) { container.removeEventListener('click', handleLeaderboardClick); container.addEventListener('click', handleLeaderboardClick); } }
            function handleEditPoints(postId, userId) { const post = window.dbData.posts[postId]; const teamResults = post.approvedResults?.[userId]; const teamName = window.dbData.users[userId]?.team?.name || 'Team'; if(!teamResults) { showModal('error', 'No results', 'This team has no approved results to edit.'); return; } const modalBox = document.getElementById('edit-points-modal-box'); let formHTML = `<form id="edit-points-form" class="space-y-4"><h3 class="text-xl font-bold mb-2">Edit Points for ${teamName}</h3>`; post.details.maps.forEach(map => { formHTML += `<div class="p-2 bg-gray-900/50 rounded-lg"><p class="font-semibold text-green-400">${map}</p><div class="grid grid-cols-2 gap-2 mt-1"><input type="number" class="form-input text-sm" placeholder="Kills" name="${map}-kills" value="${teamResults[map]?.kills || 0}"><input type="number" class="form-input text-sm" placeholder="Position" name="${map}-position" value="${teamResults[map]?.position || 0}"></div></div>`; }); formHTML += `<div><label class="form-label">Reason for Edit</label><textarea name="edit-reason" class="form-textarea" rows="3" placeholder="Explain why you are changing the points..." required></textarea></div>`; formHTML += `<div><label class="form-label">Evidence Screenshot (Optional)</label><input type="file" name="edit-screenshot" accept="image/*" class="text-sm file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-100 file:text-green-700 hover:file:bg-green-200"></div>`; formHTML += `<div class="flex gap-2 mt-4"><button type="button" id="close-edit-modal-btn" class="flex-1 py-2 bg-gray-600 rounded-lg">Cancel</button><button type="submit" class="flex-1 py-2 action-button rounded-lg">Save & Notify</button></div></form>`; modalBox.innerHTML = formHTML; screens.editPoints.classList.remove('hidden'); modalBox.querySelector('#close-edit-modal-btn').addEventListener('click', ()=>screens.editPoints.classList.add('hidden')); modalBox.querySelector('#edit-points-form').addEventListener('submit', async (e) => { e.preventDefault(); handleFormSubmit(e.target, 'Saving...', async () => { const uploadResult = await uploadImage(e.target.elements['edit-screenshot'].files[0], 'ban-evidence'); const screenshotDataUrl = uploadResult ? uploadResult.url : null; if (uploadResult) updateTotalStorage(uploadResult.size); const reason = e.target.elements['edit-reason'].value; const mailId = Date.now(); const updates = {}; updates[`/users/${userId}/mailbox/${mailId}`] = { id: mailId, postId: parseInt(postId), type: 'edit', subject: 'Points Updated by Sponsor', body: { reason, screenshot: screenshotDataUrl }, timestamp: new Date().toISOString(), read: false }; updates[`/users/${auth.currentUser.uid}/mailbox/${mailId}`] = { ...updates[`/users/${userId}/mailbox/${mailId}`], subject: `Points updated for ${teamName}` }; post.details.maps.forEach(map => { updates[`/posts/${postId}/approvedResults/${userId}/${map}`] = { kills: e.target.elements[`${map}-kills`].value, position: e.target.elements[`${map}-position`].value, edited: true }; }); await database.ref().update(updates); screens.editPoints.classList.add('hidden'); showModal('success', 'Points Updated', `The user has been notified.`); }); }); }
            function renderSponsorTeamsTab(postId) { const post = window.dbData.posts[postId]; const container = document.getElementById('sponsor-teams-content'); if(!container) return; const teamsHTML = Object.values(post.participants || {}).map(p => { const team = window.dbData.users[p.userId]?.team; if(!team) return ''; return `<button class="p-3 bg-gray-800 rounded-lg team-container text-left w-full" data-user-id="${p.userId}"><p class="font-semibold">${team.name}</p></button>`}).join(''); container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div class="md:col-span-1 flex flex-col gap-2">${teamsHTML || '<p class="text-gray-500">No teams.</p>'}</div><div id="sponsor-team-details" class="md:col-span-2 bg-black/20 p-4 rounded-lg"><p class="text-gray-500 text-center mt-8">Select a team to view submissions.</p></div></div>`; container.querySelectorAll('.team-container').forEach(el => { el.addEventListener('click', () => { container.querySelectorAll('.team-container').forEach(btn => btn.classList.replace('bg-green-600', 'bg-gray-800')); el.classList.replace('bg-gray-800','bg-green-600'); renderSponsorTeamDetails(postId, el.dataset.userId); }); }); }
            function renderSponsorTeamDetails(postId, userId) { const post = window.dbData.posts[postId]; const team = window.dbData.users[userId]?.team; if(!post || !team) return; const container = document.getElementById('sponsor-team-details'); const userSubmissions = post.results?.[userId] || {}; const approvedSubmissions = post.approvedResults?.[userId] || {}; const detailsHTML = post.details.maps.map(map => { const submission = userSubmissions[map]; const isApproved = !!approvedSubmissions[map]; let buttonsHTML = ''; if (isApproved) { buttonsHTML = `<button class="w-full mt-3 py-2 rounded text-xs font-bold bg-green-700 cursor-not-allowed" disabled>Approved</button>`; } else if (submission) { buttonsHTML = `<div class="flex gap-2 mt-3"><button class="flex-1 py-2 rounded text-xs font-bold bg-red-600 hover:bg-red-700 reject-result-btn" data-map-name="${map}">Reject</button><button class="flex-1 py-2 rounded text-xs font-bold bg-blue-600 hover:bg-blue-700 approve-result-btn" data-map-name="${map}">Approve</button></div>`; } else { buttonsHTML = `<button class="w-full mt-3 py-2 rounded text-xs font-bold bg-gray-600 hover:bg-gray-700 mark-dnp-btn" data-map-name="${map}">Mark as DNP (0 Pts)</button>`; } if (!submission) { return `<div class="p-4 bg-[#28282B] rounded-lg text-sm"><p class="font-bold text-lg">${map}</p><p class="text-gray-400 mt-2">No submission yet.</p>${buttonsHTML}</div>`; } return `<div class="p-4 bg-[#28282B] rounded-lg text-sm space-y-2"><p class="font-bold text-lg">${map}</p><p>Kills: <span class="font-semibold">${submission.kills}</span> | Position: <span class="font-semibold">#${submission.position}</span></p>${submission.screenshot ? `<div><img src="${submission.screenshot}" class="w-full h-auto object-cover rounded-md cursor-pointer mt-2" onclick="event.stopPropagation(); showLightbox('${submission.screenshot}')"></div>` : '<p class="text-xs text-gray-500 mt-2">No screenshot</p>'}${buttonsHTML}</div>`; }).join(''); container.innerHTML = `<h4 class="font-bold text-xl mb-3">${team.name}'s Submissions</h4><div class="space-y-3">${detailsHTML}</div>`; container.querySelectorAll('.approve-result-btn').forEach(btn => btn.addEventListener('click', () => handleApproveResult(postId, userId, btn.dataset.mapName))); container.querySelectorAll('.mark-dnp-btn').forEach(btn => btn.addEventListener('click', () => handleMarkAsDNP(postId, userId, btn.dataset.mapName))); container.querySelectorAll('.reject-result-btn').forEach(btn => btn.addEventListener('click', () => handleRejectResult(postId, userId, btn.dataset.mapName))); }
            function renderSponsorManageTab(postId) { const post = window.dbData.posts[postId]; const container = document.getElementById('sponsor-manage-content'); if(!container) return; let actionsHTML = ''; if (post.status === 'live_idpass_pending') { actionsHTML += `<button class="w-full py-3 rounded-lg text-lg text-white bg-blue-600 hover:bg-blue-700 set-idpass-btn">Set ID & Pass</button>`; } else if (post.status === 'live_idpass_set' || post.status === 'live_match_running') { if(post.roomId && post.roomPass) { actionsHTML += `<div class="bg-gray-800 border border-green-700 rounded-xl p-4 mb-4 shadow-lg"><h3 class="text-lg font-bold text-center text-green-300 mb-3">Room Details</h3><div class="space-y-3"><div class="flex justify-between items-center bg-black/30 p-2 rounded-lg"><span class="text-gray-400 text-sm font-semibold">Room ID:</span><code class="text-white font-bold text-lg">${post.roomId}</code><button class="copy-btn bg-gray-600 hover:bg-gray-500 w-8 h-8 rounded-md flex items-center justify-center" data-copy-text="${post.roomId}"><i class="fa-solid fa-copy"></i></button></div><div class="flex justify-between items-center bg-black/30 p-2 rounded-lg"><span class="text-gray-400 text-sm font-semibold">Password:</span><code class="text-white font-bold text-lg">${post.roomPass}</code><button class="copy-btn bg-gray-600 hover:bg-gray-500 w-8 h-8 rounded-md flex items-center justify-center" data-copy-text="${post.roomPass}"><i class="fa-solid fa-copy"></i></button></div></div></div>`; } if (post.status === 'live_idpass_set') { actionsHTML += `<button class="w-full py-3 rounded-lg text-lg action-button match-start-btn">Start Match</button>`; } else { const mapStates = post.mapStates || {}; const mapButtons = post.details.maps.map(map => { const isUnlocked = mapStates[map]?.submissionOpen === true; return `<button class="w-full py-3 rounded-lg text-base font-bold toggle-submission-btn ${isUnlocked ? 'bg-green-800 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}" data-map-name="${map}" ${isUnlocked ? 'disabled' : ''}>${isUnlocked ? `${map} Submissions Open` : `Unlock ${map} Submissions`}</button>`; }).join(''); actionsHTML += `<h3 class="text-xl font-bold mb-3">Unlock Map Submissions</h3><div class="space-y-3">${mapButtons}</div>`; } } container.innerHTML = `<div class="space-y-4 max-w-sm mx-auto">${actionsHTML}</div>`; container.querySelector('.set-idpass-btn')?.addEventListener('click', () => showIdPassModal(postId)); container.querySelector('.match-start-btn')?.addEventListener('click', () => handleMatchStart(postId)); container.querySelectorAll('.toggle-submission-btn').forEach(btn => { btn.addEventListener('click', e => { const mapName = e.target.dataset.mapName; database.ref(`/posts/${postId}/mapStates/${mapName}/submissionOpen`).set(true); }); }); container.querySelectorAll('.copy-btn').forEach(btn => { btn.addEventListener('click', (e) => { const text = e.currentTarget.dataset.copyText; navigator.clipboard.writeText(text).then(() => showModal('success', 'Copied!', 'Room details copied to clipboard.')); }); }); }
            
            async function handleApproveResult(postId, userId, mapName) { 
                const submission = window.dbData.posts[postId]?.results?.[userId]?.[mapName]; 
                if (!submission) return; 
                await database.ref(`/posts/${postId}/approvedResults/${userId}/${mapName}`).set(submission);
                // Re-render the same team's details instead of closing
                renderSponsorTeamDetails(postId, userId);
            }
            
            function handleSendPrizes(postId) {
                showCustomModal({
                    type: 'success',
                    title: 'Confirm Finalization',
                    message: 'Are you sure all results are correct? This will distribute prizes and cannot be undone.',
                    primaryButton: {
                        text: 'Yes, Finalize',
                        onClick: () => {
                            const post = window.dbData.posts[postId];
                            if (!post) return;
            
                            if (post.details.eventType === 'practice') {
                                const updates = {};
                                updates[`/posts/${postId}/status`] = 'completed';
                                updates[`/posts/${postId}/completedAt`] = new Date().toISOString();
                                const sponsor = currentUserData;
                                updates[`/users/${auth.currentUser.uid}/analytics/giveawayMatches`] = (sponsor.analytics?.giveawayMatches || 0) + 1;
                                
                                database.ref().update(updates).then(() => {
                                    showModal('success', 'Match Finalized', 'This practice match is now complete.');
                                    if (!screens.sponsorLive.classList.contains('hidden')) {
                                        screens.sponsorLive.classList.add('hidden');
                                        delete screens.sponsorLive.dataset.postId;
                                    }
                                });
                                return;
                            }

                            const updates = {};
                            let totalPrizesPaid = 0;
                            const approvedResults = post.approvedResults || {};

                            const finalRankings = Object.values(post.participants || {}).map(p => {
                                let totalPoints = 0;
                                if (approvedResults[p.userId]) {
                                    Object.values(approvedResults[p.userId]).forEach(mapResult => {
                                        totalPoints += calculatePoints(mapResult.kills, mapResult.position);
                                    });
                                }
                                return { userId: p.userId, totalPoints };
                            }).sort((a, b) => b.totalPoints - a.totalPoints);

                            (post.details.winningPrizes || []).forEach(prizeInfo => {
                                const rankMatch = prizeInfo.rank.match(/Top (\d+)/);
                                if (rankMatch) {
                                    const rank = parseInt(rankMatch[1]);
                                    if (!isNaN(rank) && finalRankings.length >= rank) {
                                        const winnerUserId = finalRankings[rank - 1].userId;
                                        const winnerUserData = window.dbData.users[winnerUserId];
                                        if (winnerUserData) {
                                            const newLiveBalance = (winnerUserData.wallet.live || 0) + prizeInfo.prize;
                                            updates[`/users/${winnerUserId}/wallet/live`] = newLiveBalance;
                                            totalPrizesPaid += prizeInfo.prize;
                                        }
                                    }
                                }
                            });

                            const totalIncome = (post.slots.booked || 0) * post.entryFee;
                            const profit = totalIncome - totalPrizesPaid;
                            
                            updates[`/posts/${postId}/status`] = 'completed';
                            updates[`/posts/${postId}/completedAt`] = new Date().toISOString();
                            updates[`/posts/${postId}/profit`] = profit;
                            
                            const sponsor = currentUserData;

                            database.ref().update(updates).then(() => {
                                showModal('success', 'Prizes Sent!', 'Prizes have been distributed and the match is now complete.', 'OK', () => {
                                    screens.sponsorLive.classList.add('hidden');
                                    navigateToPage('manage-posts-content');
                                });
                            }).catch(handleFirebaseError);
                        }
                    },
                    secondaryButton: {
                        text: 'Cancel'
                    }
                });
            }

            function calculateAndDisplayReputation() { const sponsorId = auth.currentUser.uid; const sponsor = window.dbData.users[sponsorId]; const sponsorPosts = Object.values(window.dbData.posts || {}).filter(p => p.authorId === sponsorId); const totalLikes = sponsor.reputation?.likes || 0; let totalRatings = 0, ratingCount = 0, successfulEvents = 0; sponsorPosts.forEach(post => { if (post.status === 'completed') successfulEvents++; if (post.feedback) { Object.values(post.feedback).forEach(fb => { totalRatings += fb.rating; ratingCount++; }); } }); const avgRating = ratingCount > 0 ? (totalRatings / ratingCount).toFixed(1) : '0.0'; document.getElementById('sponsor-total-likes').textContent = totalLikes; document.getElementById('sponsor-avg-rating').textContent = avgRating; document.getElementById('sponsor-success-rate').textContent = `${successfulEvents}/${sponsorPosts.length}`; }
            function renderFeedbackPage() { const sponsorId = auth.currentUser.uid; const myPostsWithFeedback = Object.values(window.dbData.posts || {}).filter(p => p.authorId === sponsorId && p.feedback && Object.keys(p.feedback).length > 0); const container = document.getElementById('feedback-content'); let feedbackHTML = ``; if(myPostsWithFeedback.length === 0) { feedbackHTML += `<p class="text-center text-gray-500 p-8">No feedback received yet.</p>`; } else { myPostsWithFeedback.forEach(post => { feedbackHTML += `<div class="mb-6 bg-[#1e1e1e] p-4 rounded-xl"><h3 class="font-bold text-lg text-green-400">${post.details.eventName}</h3>`; Object.values(post.feedback).forEach(fb => { const user = window.dbData.users[fb.userId]; const stars = Array(5).fill(0).map((_, i) => `<i class="fa-solid fa-star ${i < fb.rating ? 'text-yellow-400' : 'text-gray-600'}"></i>`).join(''); feedbackHTML += `<div class="border-t border-gray-700 mt-3 pt-3"><div class="flex items-center justify-between"><p class="font-semibold text-sm">${user ? user.name : 'Anonymous'}</p><div class="flex gap-1 text-xs">${stars}</div></div><p class="text-gray-300 text-sm mt-1 italic">"${fb.comment}"</p></div>`; }); feedbackHTML += `</div>`; }); } container.innerHTML = feedbackHTML; }
            async function showBanTeamModal(postId, userId, isMatchLive) { const post = window.dbData.posts[postId]; const user = window.dbData.users[userId]; if (!post || !user) return; const modalBox = document.getElementById('ban-team-modal-box'); let reasonFieldHTML = ''; if (isMatchLive) { reasonFieldHTML = `<div><label class="form-label">কারণ</label><select name="ban-reason-select" class="form-select" required><option value="">একটি কারণ নির্বাচন করুন</option><option value="Hacker">Hacker</option><option value="Team Up">Team Up</option><option value="Glitch User">Glitch User</option><option value="Rules Break">Rules Break</option></select></div>`; } else { reasonFieldHTML = `<div><label class="form-label">কারণ</label><input type="text" name="ban-reason-custom" class="form-input" placeholder="e.g., Team name mismatch" required></div>`; } modalBox.innerHTML = `<form id="ban-team-form" class="space-y-4"><h3 class="text-xl font-bold mb-2">Ban Team: ${user.team.name}</h3>${reasonFieldHTML}<div><label class="form-label">বিস্তারিত লিখুন (বাংলায়)</label><textarea name="ban-notice" class="form-textarea" rows="3" placeholder="এখানে বিস্তারিত লিখুন..." required></textarea></div><div><label class="form-label">প্রমাণ (ছবি)</label><input type="file" name="ban-screenshot" accept="image/*" class="text-sm w-full file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-700 file:text-white hover:file:bg-gray-800"></div><div><label class="form-label">প্রমাণ (ভিডিও লিঙ্ক)</label><input type="text" name="ban-video-link" class="form-input" placeholder="ভিডিও লিঙ্ক দিন (Google Drive, etc.)"></div><div class="flex gap-2 mt-4"><button type="button" id="close-ban-modal-btn" class="flex-1 py-2 bg-gray-600 rounded-lg">Cancel</button><button type="submit" class="flex-1 py-2 bg-red-600 rounded-lg">Confirm Ban</button></div></form>`; screens.banTeam.classList.remove('hidden'); modalBox.querySelector('#close-ban-modal-btn').addEventListener('click', () => screens.banTeam.classList.add('hidden')); modalBox.querySelector('#ban-team-form').addEventListener('submit', e => { e.preventDefault(); handleFormSubmit(e.target, 'Banning Team...', async () => { const form = e.target; const videoLink = form.elements['ban-video-link'].value; const uploadResult = await uploadImage(form.elements['ban-screenshot'].files[0], 'ban-evidence'); const screenshotDataUrl = uploadResult ? uploadResult.url : null; if (uploadResult) updateTotalStorage(uploadResult.size); const reason = isMatchLive ? form.elements['ban-reason-select'].value : form.elements['ban-reason-custom'].value; const notice = form.elements['ban-notice'].value; const fullReason = `${reason}: ${notice}`; const updates = {}; const mailId = Date.now(); updates[`/users/${userId}/mailbox/${mailId}`] = { id: mailId, postId: parseInt(postId), type: 'ban', subject: `You were banned from a match`, body: { reason: fullReason, screenshot: screenshotDataUrl, videoLink: videoLink, refunded: !isMatchLive }, timestamp: new Date().toISOString(), read: false, sponsorId: auth.currentUser.uid }; updates[`/users/${auth.currentUser.uid}/mailbox/${mailId}`] = { ...updates[`/users/${userId}/mailbox/${mailId}`], subject: `You banned ${user.team.name}`, type: 'ban_record' }; const bannedUsers = post.bannedUsers || []; if (!bannedUsers.includes(userId)) { bannedUsers.push(userId); } updates[`/posts/${postId}/bannedUsers`] = bannedUsers; const participantKey = Object.keys(post.participants || {}).find(key => post.participants[key].userId === userId); if (participantKey) { if (isMatchLive && post.entryFee > 0) { updates[`/users/${auth.currentUser.uid}/wallet/event`] = (currentUserData.wallet.event || 0) + post.entryFee; } else if (!isMatchLive) { updates[`/users/${userId}/wallet/live`] = (user.wallet.live || 0) + post.entryFee; updates[`/users/${auth.currentUser.uid}/wallet/event`] = (currentUserData.wallet.event || 0) - post.entryFee; } updates[`/posts/${postId}/participants/${participantKey}`] = null; updates[`/posts/${postId}/slots/booked`] = (post.slots.booked || 1) - 1; } await database.ref().update(updates); screens.banTeam.classList.add('hidden'); if (document.getElementById('participant-list-content')) { document.getElementById('participant-list-content').innerHTML = ''; } if (!screens.participants.classList.contains('hidden')) { screens.participants.classList.add('hidden'); } showModal('success', 'Team Banned', `${user.team.name} has been banned and notified.`); }); }); }
            function updateMailboxBadge() { const unreadCount = Object.values(currentUserData.mailbox || {}).filter(m => !m.read).length; const navItem = document.getElementById('nav-mailbox'); const badge = navItem.querySelector('.notification-badge'); if (unreadCount > 0) { if (badge) { badge.textContent = unreadCount; } else { navItem.innerHTML += `<div class="notification-badge">${unreadCount}</div>`; } } else { if (badge) badge.remove(); } }
            
            // MODIFIED: Added delete button and functionality to renderMailbox
            function renderMailbox() {
                const content = document.getElementById('mailbox-content');
                const sortedMail = Object.values(currentUserData.mailbox || {}).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                let mailHTML = sortedMail.map(mail => {
                    const isAlert = mail.type === 'report_notification' || mail.type === 'ban_reported' || mail.type === 'punishment';
                    const contactButton = isAlert && mail.type !== 'punishment' ? `<a href="https://t.me/Op_tonmoy" target="_blank" class="block text-center mt-3 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-bold">Contact Admin</a>` : '';
                    return `<div class="mail-item p-4 border-l-4 ${mail.read ? 'border-gray-700' : (isAlert ? 'border-red-500 bg-[#2a2a2a]' : 'border-green-500 bg-[#1e1e1e]') } rounded-r-lg" data-mail-id="${mail.id}">
                                <button class="delete-mail-btn absolute top-3 right-3 text-gray-600 hover:text-red-500 text-2xl leading-none" data-mail-id="${mail.id}">&times;</button>
                                <div class="flex justify-between items-start">
                                    <div class="pr-8"><p class="font-bold">${mail.subject}</p></div>
                                    <span class="text-xs text-gray-500 flex-shrink-0">${timeAgo(mail.timestamp)}</span>
                                </div>
                                <div class="mail-body mt-2 pt-2 border-t border-gray-700/50 text-gray-300 text-sm">
                                    <p>${mail.body.reason}</p>
                                    ${mail.body.screenshot ? `<p class="mt-2">Evidence:</p><img src="${mail.body.screenshot}" class="w-full max-w-xs h-auto object-cover rounded-md cursor-pointer mt-1" onclick="event.stopPropagation(); showLightbox('${mail.body.screenshot}')">` : ''}
                                    ${contactButton}
                                </div>
                            </div>`;
                }).join('');
                content.innerHTML = `<div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Mailbox</h2></div><div class="space-y-3">${sortedMail.length > 0 ? mailHTML : '<p class="text-center text-gray-500 mt-8">Your mailbox is empty.</p>'}</div>`;
                
                content.querySelectorAll('.mail-item').forEach(item => {
                    const mailId = item.dataset.mailId;
                    if (!currentUserData.mailbox[mailId]?.read) {
                        item.addEventListener('click', (e) => {
                            if (e.target.closest('.delete-mail-btn')) return; // Don't mark as read if delete is clicked
                            database.ref(`users/${auth.currentUser.uid}/mailbox/${mailId}/read`).set(true);
                        }, { once: true });
                    }
                });
                
                content.querySelectorAll('.delete-mail-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const mailId = e.currentTarget.dataset.mailId;
                        showCustomModal({
                            type: 'error',
                            title: 'Delete Mail?',
                            message: 'Are you sure you want to permanently delete this message?',
                            primaryButton: { text: 'Delete', onClick: () => {
                                database.ref(`users/${auth.currentUser.uid}/mailbox/${mailId}`).remove();
                            }},
                            secondaryButton: { text: 'Cancel' }
                        });
                    });
                });
            }
            
            function renderHistoryPage() { const historyContainer = document.getElementById('history-content'); const myPosts = Object.values(window.dbData.posts || {}).filter(p => p.authorId === auth.currentUser.uid && (p.status === 'completed' || p.status === 'cancelled')).sort((a,b) => b.timestamp - a.timestamp); let historyHTML = myPosts.map(post => createManagePostCardHTML(post)).join(''); historyContainer.innerHTML = `<div class="space-y-4">${historyHTML || '<p class="text-gray-500 text-center p-8">No event history found.</p>'}</div>`; }

            function renderKycPage() {
                const container = document.getElementById('kyc-content');
                if (!container || !currentUserData) return;
                const status = currentUserData.kycStatus || 'none';
                let html = '';

                if (status === 'verified') {
                    html = `<div class="p-4 bg-green-900/50 border border-green-700 rounded-xl text-center">
                                <img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Levelup%2F1762353787074.png?alt=media&token=879ec01c-3c6b-4603-9f6a-5022421d7e4e" class="w-24 h-24 mx-auto mb-2">
                                <i class="fa-solid fa-check-circle text-green-400 text-2xl mb-2"></i>
                                <h4 class="font-bold text-lg">You are a Verified Organizer</h4>
                            </div>`;
                } else if (status === 'pending') {
                    html = `<div class="p-4 bg-yellow-900/50 border border-yellow-700 rounded-xl text-center"><i class="fa-solid fa-clock text-yellow-400 text-2xl mb-2"></i><h4 class="font-bold text-lg">Verification Pending</h4><p class="text-sm text-yellow-200">Your documents are under review. This may take up to 24-48 hours.</p></div>`;
                } else {
                     const rejectionReason = currentUserData.rejectionReason ? `<p class="text-sm text-red-300 bg-red-900/50 p-2 rounded-md mb-4"><b>Reason:</b> ${currentUserData.rejectionReason}</p>` : '';
                    html = `<div class="p-4 bg-gray-800 border border-gray-700 rounded-xl">
                                ${rejectionReason}
                                <div class="flex flex-col items-center mb-4">
                                    <img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Levelup%2F1762353787074.png?alt=media&token=879ec01c-3c6b-4603-9f6a-5022421d7e4e" class="w-24 h-24 mx-auto mb-2">
                                </div>
                                <form id="kyc-form" class="space-y-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        ${createImageUploadField('nid-front', 'NID Card (Front)')}
                                        ${createImageUploadField('nid-back', 'NID Card (Back)')}
                                    </div>
                                    ${createImageUploadField('selfie', 'Face Selfie')}
                                    <div>
                                        <label for="kyc-whatsapp" class="form-label">WhatsApp Number</label>
                                        <input type="tel" id="kyc-whatsapp" name="kyc-whatsapp" value="${currentUserData.whatsapp ? currentUserData.whatsapp.replace('+880', '') : ''}" class="form-input" required placeholder="01...">
                                    </div>
                                    <button type="submit" class="w-full py-3 mt-2 action-button rounded-lg">Submit for Verification</button>
                                </form>
                            </div>`;
                }
                container.innerHTML = html;
                if(status === 'none' || status === 'rejected') {
                    setupKycForm();
                }
            }
            function createImageUploadField(id, label) {
                return `<div>
                            <label class="form-label">${label}</label>
                            <input type="file" id="kyc-${id}-upload" class="hidden" accept="image/*" required>
                            <label for="kyc-${id}-upload" class="kyc-upload-box w-full h-32 rounded-lg flex flex-col items-center justify-center text-gray-400 cursor-pointer">
                                <img id="kyc-${id}-preview" class="hidden w-full h-full object-cover rounded-lg">
                                <div id="kyc-${id}-placeholder">
                                    <i class="fa-solid fa-camera text-3xl"></i>
                                    <p class="text-sm mt-1">Upload Photo</p>
                                </div>
                            </label>
                        </div>`;
            }
            function setupKycForm() {
                const form = document.getElementById('kyc-form');
                if(!form) return;
                ['nid-front', 'nid-back', 'selfie'].forEach(id => {
                    const input = document.getElementById(`kyc-${id}-upload`);
                    input.addEventListener('change', (e) => {
                        if (e.target.files[0]) {
                            const reader = new FileReader();
                            reader.onload = ev => {
                                document.getElementById(`kyc-${id}-preview`).src = ev.target.result;
                                document.getElementById(`kyc-${id}-preview`).classList.remove('hidden');
                                document.getElementById(`kyc-${id}-placeholder`).classList.add('hidden');
                            };
                            reader.readAsDataURL(e.target.files[0]);
                        }
                    });
                });
                form.addEventListener('submit', handleKycSubmit);
            }
            async function handleKycSubmit(e) {
                e.preventDefault();
                const form = e.target;
                handleFormSubmit(form, 'Submitting...', async () => {
                    const nidFrontFile = document.getElementById('kyc-nid-front-upload').files[0];
                    const nidBackFile = document.getElementById('kyc-nid-back-upload').files[0];
                    const selfieFile = document.getElementById('kyc-selfie-upload').files[0];
                    if (!nidFrontFile || !nidBackFile || !selfieFile) throw new Error("Please upload all three required images.");

                    const [nidFrontResult, nidBackResult, selfieResult] = await Promise.all([
                        uploadImage(nidFrontFile, 'kyc'),
                        uploadImage(nidBackFile, 'kyc'),
                        uploadImage(selfieFile, 'kyc')
                    ]);
                    
                    if (!nidFrontResult || !nidBackResult || !selfieResult) {
                         throw new Error("One or more images failed to upload. Please try again.");
                    }
                    
                    const submissionData = {
                        nidFrontUrl: nidFrontResult.url,
                        nidBackUrl: nidBackResult.url,
                        selfieUrl: selfieResult.url,
                        whatsapp: '+880' + document.getElementById('kyc-whatsapp').value,
                        status: 'pending',
                        submittedAt: new Date().toISOString()
                    };

                    const updates = {};
                    updates[`/kycSubmissions/${auth.currentUser.uid}`] = submissionData;
                    updates[`/users/${auth.currentUser.uid}/kycStatus`] = 'pending';
                    updates[`/users/${auth.currentUser.uid}/rejectionReason`] = null;

                    await database.ref().update(updates);
                    showModal('success', 'Submitted!', 'Your verification request has been sent for review.');
                });
            }
            
            // MODIFIED: Complete redesign of the Events & Earnings page
            function renderEventsAndEarningsPage() {
                const container = document.getElementById('statement-content');
                const myPosts = Object.values(window.dbData.posts || {}).filter(p => p.authorId === auth.currentUser.uid).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                const upcomingPosts = myPosts.filter(p => p.status === 'upcoming');
                const livePosts = myPosts.filter(p => p.status.startsWith('live'));
                const completedPosts = myPosts.filter(p => p.status === 'completed');

                const createEventCard = (post) => {
                    const collectedFees = (post.slots.booked || 0) * post.entryFee;
                    let bottomContent = '';

                    if (post.details.eventType === 'practice') {
                        return `<div class="statement-card p-4 rounded-lg space-y-2 border-orange-500">
                                    <div class="flex justify-between items-center">
                                        <p class="font-bold truncate">${post.details.eventName}</p>
                                        <span class="text-xs font-bold bg-orange-500 text-white px-2 py-1 rounded-full">Practice</span>
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-400">Participants: <strong class="text-white">${post.slots.booked || 0}/${post.slots.total}</strong></span>
                                    </div>
                                </div>`;
                    }
                    
                    if (post.status === 'completed') {
                        const profit = post.profit || 0;
                        const profitColor = profit >= 0 ? 'text-green-400' : 'text-red-400';
                        let transferHTML = '';
                        if(post.profitTransferred) {
                            transferHTML = `<p class="text-sm font-bold text-green-500">Transferred</p>`;
                        } else if (post.profitLocked) {
                             transferHTML = `<div class="text-center text-sm text-yellow-400"><i class="fa-solid fa-lock"></i><p>Locked</p></div>`;
                        } else {
                            const eligibilityTime = new Date(post.completedAt || post.timestamp).getTime() + (5 * 60 * 60 * 1000); // 5 hours
                            if(Date.now() > eligibilityTime) {
                                transferHTML = `<button class="text-white bg-blue-600 hover:bg-blue-700 py-2 px-4 rounded-lg text-xs font-bold transfer-profit-btn" data-post-id="${post.id}" data-profit="${profit}">Transfer to Live</button>`;
                            } else {
                                transferHTML = `<div class="text-center"><p class="text-xs text-gray-500">Available in:</p><p class="font-bold text-yellow-400 profit-countdown" data-countdown-to="${eligibilityTime}">00:00:00</p></div>`;
                            }
                        }
                        bottomContent = `<div class="border-t border-gray-700 mt-3 pt-3 flex justify-between items-center">
                                            <div>
                                                <p class="text-xs text-gray-400">Net Profit</p>
                                                <p class="font-bold text-lg ${profitColor}">${profit.toFixed(2)} TK</p>
                                            </div>
                                            ${transferHTML}
                                        </div>`;
                    }

                    return `<div class="statement-card p-4 rounded-lg space-y-2 border-green-500">
                                <p class="font-bold truncate">${post.details.eventName}</p>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-400">Participants: <strong class="text-white">${post.slots.booked || 0}/${post.slots.total}</strong></span>
                                    <span class="text-gray-400">Collected: <strong class="text-white">${collectedFees.toFixed(2)} TK</strong></span>
                                </div>
                                ${bottomContent}
                            </div>`;
                };

                container.innerHTML = `
                    <div class="flex gap-2 mb-4 sticky top-[70px] bg-[#121212] py-2 z-10">
                        <button class="tab-button statement-tab" data-target="completed-section">Completed</button>
                        <button class="tab-button statement-tab" data-target="live-section">Live</button>
                        <button class="tab-button statement-tab" data-target="upcoming-section">Upcoming</button>
                    </div>
                    <div id="completed-section" class="tab-content-section space-y-3">
                        ${completedPosts.length > 0 ? completedPosts.map(createEventCard).join('') : '<p class="text-gray-500 text-center p-8">No completed events found.</p>'}
                    </div>
                    <div id="live-section" class="tab-content-section space-y-3">
                        ${livePosts.length > 0 ? livePosts.map(createEventCard).join('') : '<p class="text-gray-500 text-center p-8">No events are currently live.</p>'}
                    </div>
                    <div id="upcoming-section" class="tab-content-section space-y-3">
                        ${upcomingPosts.length > 0 ? upcomingPosts.map(createEventCard).join('') : '<p class="text-gray-500 text-center p-8">No upcoming events found.</p>'}
                    </div>`;

                setupTabs('statement-content', '.statement-tab', '.tab-content-section');
            }

            document.getElementById('statement-content').addEventListener('click', e => {
                const transferBtn = e.target.closest('.transfer-profit-btn');
                if(transferBtn) {
                    const postId = transferBtn.dataset.postId;
                    const profit = parseFloat(transferBtn.dataset.profit);
                    
                    showCustomModal({
                        title: 'Confirm Transfer',
                        message: `Are you sure you want to transfer ${profit.toFixed(2)} TK profit to your Live Balance?`,
                        primaryButton: { text: 'Confirm', onClick: async () => {
                            showLoader('Transferring...');
                            try {
                                const updates = {};
                                updates[`/posts/${postId}/profitTransferred`] = true;
                                updates[`/users/${auth.currentUser.uid}/wallet/live`] = firebase.database.ServerValue.increment(profit);
                                
                                await database.ref().update(updates);
                                hideLoader();
                                showModal('success', 'Transfer Successful', 'Profit has been added to your Live Balance.');
                            } catch(err) {
                                hideLoader();
                                handleFirebaseError(err);
                            }
                        }},
                        secondaryButton: { text: 'Cancel'}
                    });
                }
            });
        
            function handleMarkAsDNP(postId, userId, mapName) {
                showCustomModal({
                    title: 'Confirm Action',
                    message: `Are you sure you want to mark this team as "Did Not Play" for ${mapName}? This will assign them 0 points.`,
                    primaryButton: {
                        text: 'Yes, Mark DNP',
                        onClick: () => {
                            const dnpResult = { kills: 0, position: 0, dnp: true };
                            database.ref(`/posts/${postId}/approvedResults/${userId}/${mapName}`).set(dnpResult)
                            .then(() => renderSponsorTeamDetails(postId, userId));
                        }
                    },
                    secondaryButton: { text: 'Cancel' }
                });
            }

            function handleRejectResult(postId, userId, mapName) {
                showCustomModal({
                    type: 'error',
                    title: 'Rejection Reason',
                    message: `<p class="text-sm text-left mb-2">Why are you rejecting this submission for ${mapName}?</p><textarea id="rejection-reason" class="form-textarea" rows="3" placeholder="e.g., Wrong screenshot, invalid data..."></textarea>`,
                    primaryButton: { text: 'Confirm Rejection', noClose: true, onClick: () => {
                        const reason = document.getElementById('rejection-reason').value;
                        if (!reason.trim()) { alert('A reason is required to reject a submission.'); return; }
                        const updates = {};
                        updates[`/posts/${postId}/results/${userId}/${mapName}`] = null; // This will "unlock" it
                        const mailId = Date.now();
                        updates[`/users/${userId}/mailbox/${mailId}`] = {
                            id: mailId, postId: parseInt(postId), type: 'rejection', read: false,
                            subject: 'Result Submission Rejected',
                            body: { reason: `Your submission for map "${mapName}" was rejected. Reason: ${reason}. Please submit again.` },
                            timestamp: new Date().toISOString()
                        };
                        database.ref().update(updates).then(() => {
                            document.getElementById('modal-screen').classList.add('hidden');
                            showModal('success', 'Submission Rejected', 'The user has been notified and can now re-submit their results.');
                            renderSponsorTeamDetails(postId, userId); // Re-render the team details view
                        });
                    }},
                    secondaryButton: { text: 'Cancel' }
                });
            }

            function checkFinalizeButtonState(postId) {
                const post = window.dbData.posts[postId];
                const sendPrizesBtn = document.getElementById('send-prizes-btn');
                if (!sendPrizesBtn) return;
                
                const participantUserIds = Object.values(post.participants || {}).map(p => p.userId);
                const approvedResults = post.approvedResults || {};
                const numMaps = post.details.maps.length;
                
                let allResultsIn = true;
                
                if (participantUserIds.length === 0) {
                    allResultsIn = false;
                } else {
                    for (const userId of participantUserIds) {
                        const userApprovedResults = approvedResults[userId] || {};
                        if (Object.keys(userApprovedResults).length < numMaps) {
                            allResultsIn = false; 
                            break;
                        }
                    }
                }
                
                sendPrizesBtn.disabled = !allResultsIn;
                if (allResultsIn) {
                    sendPrizesBtn.textContent = 'Send Prizes & Finalize';
                } else {
                    sendPrizesBtn.textContent = 'Waiting for all approved results...';
                }
            }
            function renderSponsorParticipantsTab(postId) { 
                const post = window.dbData.posts[postId]; 
                const container = document.getElementById('sponsor-participants-content'); 
                if (!container) return; 
                const participants = Object.values(post.participants || {}); 
                const bannedUsers = post.bannedUsers || []; 
                const isLive = post.status.startsWith('live');
                const participantsHTML = participants.map(p => { 
                    const user = window.dbData.users[p.userId]; 
                    const team = user?.team; 
                    if (!user) return ''; 
                    const teamName = post.details.teamType.toLowerCase() === 'solo' ? p.players[0].name : (team ? team.name : 'Unknown Team'); 
                    
                    const kickButtonHTML = isLive 
                        ? `<button class="bg-yellow-800 text-yellow-500 cursor-not-allowed px-3 py-1 text-xs rounded-md" disabled title="Cannot kick during a live match">Kick</button>`
                        : `<button class="kick-team-btn bg-yellow-600 hover:bg-yellow-700 px-3 py-1 text-xs rounded-md" data-user-id="${p.userId}" data-post-id="${postId}">Kick</button>`;
                        
                    return `<div class="bg-[#2a2a2a] rounded-lg p-3 flex justify-between items-center ${bannedUsers.includes(p.userId) ? 'opacity-50' : ''}"><div><p class="font-semibold text-white">#${p.slotNumber} ${teamName}</p><p class="text-xs text-gray-400">IGL: ${user.name || 'N/A'}</p></div>${bannedUsers.includes(p.userId) ? '<span class="text-red-400 font-bold text-sm">BANNED</span>' : `<div class="flex gap-2">${kickButtonHTML}<button class="ban-team-btn bg-red-600 hover:bg-red-700 px-3 py-1 text-xs rounded-md" data-user-id="${p.userId}" data-post-id="${postId}">Ban</button></div>`}</div>`; 
                }).join(''); 
                container.innerHTML = `<h3 class="text-xl font-bold mb-3">Match Participants (${participants.length}/${post.slots.total})</h3><div class="space-y-2">${participantsHTML || '<p class="text-gray-500 p-4">No teams found.</p>'}</div>`; 
                container.querySelectorAll('.ban-team-btn').forEach(btn => { btn.addEventListener('click', e => { showBanTeamModal(e.target.dataset.postId, e.target.dataset.userId, true); }); }); 
                container.querySelectorAll('.kick-team-btn').forEach(btn => { btn.addEventListener('click', e => { handleKickTeam(e.target.dataset.postId, e.target.dataset.userId); }); }); 
            }
        
            function renderProOrganizerProgress() {
                const section = document.getElementById('pro-organizer-progress-section');
                if (!currentUserData || currentUserData.kycStatus !== 'verified') {
                    section.classList.add('hidden');
                    return;
                }
                section.classList.remove('hidden');

                const matchesTarget = 500;
                const likesTarget = 1000;

                const completedMatches = Object.values(window.dbData.posts || {}).filter(p => p.authorId === auth.currentUser.uid && p.status === 'completed').length;
                const likes = currentUserData.reputation?.likes || 0;

                const matchesPercentage = Math.min(100, (completedMatches / matchesTarget) * 100);
                const likesPercentage = Math.min(100, (likes / likesTarget) * 100);

                document.getElementById('pro-matches-counter').textContent = `${completedMatches} / ${matchesTarget}`;
                document.getElementById('pro-matches-progress').style.width = `${matchesPercentage}%`;
                document.getElementById('pro-likes-counter').textContent = `${likes} / ${likesTarget}`;
                document.getElementById('pro-likes-progress').style.width = `${likesPercentage}%`;

                const applyBtn = document.getElementById('apply-pro-badge-btn');
                const applicationStatus = window.dbData.proOrganizerApplications?.[auth.currentUser.uid]?.status;

                if (applicationStatus === 'pending') {
                    applyBtn.textContent = 'Application Pending Review';
                    applyBtn.disabled = true;
                } else if (applicationStatus === 'approved' || currentUserData.verifiedBadge === 1) {
                    applyBtn.textContent = 'Badge Awarded';
                    applyBtn.disabled = true;
                    applyBtn.classList.remove('action-button');
                    applyBtn.style.background = '#1DB954';
                } else if (completedMatches >= matchesTarget && likes >= likesTarget) {
                    applyBtn.textContent = 'Apply for Badge';
                    applyBtn.disabled = false;
                } else {
                    applyBtn.textContent = 'Apply for Badge';
                    applyBtn.disabled = true;
                }
            }

            document.getElementById('profile-content').addEventListener('click', e => {
                if (e.target.id === 'apply-pro-badge-btn') {
                    showCustomModal({
                        type: 'success',
                        title: 'Confirm Application',
                        message: 'Are you sure you want to apply for the Veteran Sponsor badge? Your application will be sent to the admins for review.',
                        primaryButton: {
                            text: 'Yes, Apply Now',
                            onClick: () => {
                                const applicationData = {
                                    sponsorId: auth.currentUser.uid,
                                    name: currentUserData.name,
                                    status: 'pending',
                                    timestamp: new Date().toISOString()
                                };
                                database.ref('proOrganizerApplications/' + auth.currentUser.uid).set(applicationData)
                                    .then(() => showModal('success', 'Application Sent!', 'Your request has been sent for review. You will be notified of the result.'))
                                    .catch(handleFirebaseError);
                            }
                        },
                        secondaryButton: { text: 'Cancel' }
                    });
                }
            });

            const backFromPaymentBtn = document.getElementById('back-from-payment-btn');
            function startDepositFlow() {
                screens.payment.classList.remove('hidden');
                document.getElementById('payment-header').classList.remove('hidden');
                document.querySelector('#payment-header h2').textContent = 'Deposit Money';
                backFromPaymentBtn.onclick = () => { screens.payment.classList.add('hidden'); };
                renderPaymentMethodSelection('deposit');
            }
            function startWithdrawFlow() {
                screens.payment.classList.remove('hidden');
                document.getElementById('payment-header').classList.remove('hidden');
                document.querySelector('#payment-header h2').textContent = 'Withdraw Money';
                backFromPaymentBtn.onclick = () => { screens.payment.classList.add('hidden'); };
                renderPaymentMethodSelection('withdraw');
            }
            
            // MODIFIED: Added listener for new "Events & Earnings" button in wallet
            document.getElementById('wallet-content').addEventListener('click', e => {
                if (e.target.closest('#deposit-btn')) startDepositFlow();
                if (e.target.closest('#withdraw-btn')) startWithdrawFlow();
                if (e.target.closest('#go-to-statement-btn')) {
                    navigateToPage('statement-content');
                    setActiveNavItem(null); // Don't highlight a bottom nav item
                }
            });

            function renderPaymentMethodSelection(type) {
                const contentArea = document.getElementById('payment-content-area');
                contentArea.scrollTop = 0;
                backFromPaymentBtn.onclick = () => { screens.payment.classList.add('hidden'); };
                contentArea.innerHTML = `<h2 class="text-xl font-bold text-center mb-6">Select a Payment Method</h2><div class="space-y-4 max-w-sm mx-auto">${Object.keys(paymentMethods).map(key => `<button class="w-full flex items-center p-4 rounded-xl payment-method-btn" data-method-key="${key}" data-type="${type}"><img src="${paymentMethods[key].logo}" class="payment-method-img"><span class="text-lg font-semibold">${paymentMethods[key].name}</span><i class="fa-solid fa-chevron-right text-gray-500 ml-auto"></i></button>`).join('')}</div>`;
                contentArea.querySelectorAll('.payment-method-btn').forEach(btn => btn.addEventListener('click', () => { if (type === 'deposit') renderDepositForm(btn.dataset.methodKey); else if (type === 'withdraw') renderWithdrawForm(btn.dataset.methodKey); }));
            }

            // MODIFIED: Added animation class to logo and improved UI
            function renderDepositForm(methodKey) {
                const method = paymentMethods[methodKey]; currentPaymentData = { type: 'deposit', method: method.name, methodKey };
                const contentArea = document.getElementById('payment-content-area'); contentArea.scrollTop = 0;
                backFromPaymentBtn.onclick = () => renderPaymentMethodSelection('deposit');
                contentArea.innerHTML = `<div class="max-w-md mx-auto pb-24">
                    <div class="text-center mb-6">
                        <img src="${method.logo}" class="w-24 h-24 mx-auto mb-2 object-contain deposit-logo-animated">
                        <h2 class="text-2xl font-bold">Deposit via ${method.name}</h2>
                    </div>
                    <div class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-4 space-y-3 mb-4">
                        <h3 class="font-semibold text-green-400">Instructions</h3>
                        <p class="text-sm text-gray-300">Use your ${method.name} app to <strong>${method.type}</strong> to the number below.</p>
                        <div class="bg-black/30 p-3 rounded-lg flex justify-between items-center">
                            <code class="text-xl font-bold tracking-wider">${method.number}</code>
                            <button id="copy-payment-number-btn" class="bg-gray-600 hover:bg-gray-700 w-10 h-10 rounded-md flex items-center justify-center"><i class="fa-solid fa-copy"></i></button>
                        </div>
                    </div>
                    <div class="bg-[#1e1e1e] border border-gray-700 rounded-xl p-4 space-y-4">
                        <div>
                            <label for="payment-amount" class="form-label">Amount (Min: ${MIN_DEPOSIT} - Max: ${MAX_DEPOSIT})</label>
                            <input type="number" id="payment-amount" class="form-input" required>
                        </div>
                        <div>
                            <label for="payment-trxid" class="form-label">Transaction ID (TrxID)</label>
                            <input type="text" id="payment-trxid" class="form-input" required>
                        </div>
                    </div>
                    <div class="fixed bottom-0 left-0 w-full p-4 bg-[#121212]/80 backdrop-blur-sm border-t border-gray-800">
                        <div id="payment-swipe-confirm" class="swipe-container">
                            <div class="swipe-track"></div>
                            <div class="swipe-handle"><i class="fa-solid fa-chevron-right text-white"></i><i class="fa-solid fa-chevron-right text-white -ml-2"></i></div>
                            <div class="swipe-text">SWIPE TO CONFIRM DEPOSIT</div>
                        </div>
                    </div>
                </div>`;
                document.getElementById('copy-payment-number-btn').addEventListener('click', () => { navigator.clipboard.writeText(method.number).then(() => showModal('success', 'Copied!', `${method.number} has been copied.`)); });
                
                const swipeContainer = document.getElementById('payment-swipe-confirm'), handle = swipeContainer.querySelector('.swipe-handle'), track = swipeContainer.querySelector('.swipe-track'), text = swipeContainer.querySelector('.swipe-text');
                let isDragging = false, startX = 0, currentX = 0;

                const resetSwipe = () => {
                    handle.style.transition = 'transform 0.2s ease'; handle.style.transform = 'translateX(0px)'; track.style.width = '0px'; text.style.opacity = 1;
                    setTimeout(() => handle.style.transition = '', 200);
                };
                const handleDragMove = (clientX) => { if (!isDragging) return; currentX = clientX - startX; const max = swipeContainer.offsetWidth - handle.offsetWidth - 12; let newPos = Math.max(0, Math.min(currentX, max)); handle.style.transform = `translateX(${newPos}px)`; track.style.width = `${newPos + handle.offsetWidth / 2}px`; text.style.opacity = 1 - (newPos / max); };
                const onMouseMove = (e) => handleDragMove(e.clientX);
                const onTouchMove = (e) => { e.preventDefault(); handleDragMove(e.touches[0].clientX); };

                const handleDragEnd = async () => {
                    if (!isDragging) return; isDragging = false;
                    document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', handleDragEnd); document.removeEventListener('touchmove', onTouchMove); document.removeEventListener('touchend', handleDragEnd);
                    const max = swipeContainer.offsetWidth - handle.offsetWidth - 12;
                    if (currentX > max * 0.8) {
                        const amount = parseFloat(document.getElementById('payment-amount').value); const trxId = document.getElementById('payment-trxid').value.trim().toUpperCase();
                        if (isNaN(amount) || !trxId || amount < MIN_DEPOSIT || amount > MAX_DEPOSIT) { showModal('error', 'Invalid Input', `Please ensure Amount is between ${MIN_DEPOSIT}-${MAX_DEPOSIT} and TrxID is not empty.`); resetSwipe(); return; }
                        const trxIdExists = (await database.ref('deposits').orderByChild('trxId').equalTo(trxId).once('value')).exists();
                        if (trxIdExists) { showModal('error', 'Duplicate TrxID', `This Transaction ID has already been used. Please verify and try again.`); resetSwipe(); return; }
                        currentPaymentData.amount = amount; currentPaymentData.trxId = trxId; submitDepositRequest();
                    } else { resetSwipe(); }
                };
                const handleDragStart = (clientX) => { isDragging = true; startX = clientX; currentX = 0; document.addEventListener('mousemove', onMouseMove); document.addEventListener('mouseup', handleDragEnd); document.addEventListener('touchmove', onTouchMove, { passive: false }); document.addEventListener('touchend', handleDragEnd); };
                
                handle.addEventListener('mousedown', (e) => handleDragStart(e.clientX));
                handle.addEventListener('touchstart', (e) => handleDragStart(e.touches[0].clientX), { passive: false });
            }

            async function renderWithdrawForm(methodKey) {
                const method = paymentMethods[methodKey];
                const todayWithdrawals = Object.values((await database.ref('withdrawals').orderByChild('userId').equalTo(auth.currentUser.uid).once('value')).val() || {}).filter(w => new Date(w.timestamp).toDateString() === new Date().toDateString());
                if (todayWithdrawals.length >= WITHDRAW_LIMIT_PER_DAY) { showModal('error', 'Limit Reached', `You have reached your daily withdrawal limit of ${WITHDRAW_LIMIT_PER_DAY}.`, 'OK', () => startWithdrawFlow()); return; }
                currentPaymentData = { type: 'withdraw', method: method.name, methodKey }; const contentArea = document.getElementById('payment-content-area'); contentArea.scrollTop = 0; backFromPaymentBtn.onclick = () => renderPaymentMethodSelection('withdraw');
                contentArea.innerHTML = `<div class="max-w-md mx-auto pb-24">
                    <div class="text-center mb-6">
                        <img src="${method.logo}" class="w-24 h-24 mx-auto mb-2 object-contain deposit-logo-animated">
                        <h2 class="text-2xl font-bold">Withdraw to ${method.name}</h2>
                    </div>
                    <div class="bg-[#1e1e1e] border border-gray-700 rounded-xl p-4 space-y-4">
                        <div>
                            <label for="payment-amount" class="form-label">Amount (Min: ${MIN_WITHDRAW} - Max: ${MAX_WITHDRAW})</label>
                            <input type="number" id="payment-amount" class="form-input" required>
                        </div>
                        <div>
                            <label for="account-number" class="form-label">Your ${method.name} Account Number</label>
                            <input type="tel" id="account-number" class="form-input" required>
                        </div>
                    </div>
                    <div class="fixed bottom-0 left-0 w-full p-4 bg-[#121212]/80 backdrop-blur-sm border-t border-gray-800">
                        <div id="payment-swipe-confirm" class="swipe-container">
                            <div class="swipe-track"></div>
                            <div class="swipe-handle"><i class="fa-solid fa-chevron-right text-white"></i><i class="fa-solid fa-chevron-right text-white -ml-2"></i></div>
                            <div class="swipe-text">SWIPE TO CONFIRM WITHDRAWAL</div>
                        </div>
                    </div>
                </div>`;
                
                const swipeContainer = document.getElementById('payment-swipe-confirm'), handle = swipeContainer.querySelector('.swipe-handle'), track = swipeContainer.querySelector('.swipe-track'), text = swipeContainer.querySelector('.swipe-text');
                let isDragging = false, startX = 0, currentX = 0;

                const resetSwipe = () => {
                    handle.style.transition = 'transform 0.2s ease'; handle.style.transform = 'translateX(0px)'; track.style.width = '0px'; text.style.opacity = 1;
                    setTimeout(() => handle.style.transition = '', 200);
                };
                const handleDragMove = (clientX) => { if (!isDragging) return; currentX = clientX - startX; const max = swipeContainer.offsetWidth - handle.offsetWidth - 12; let newPos = Math.max(0, Math.min(currentX, max)); handle.style.transform = `translateX(${newPos}px)`; track.style.width = `${newPos + handle.offsetWidth / 2}px`; text.style.opacity = 1 - (newPos / max); };
                const onMouseMove = (e) => handleDragMove(e.clientX);
                const onTouchMove = (e) => { e.preventDefault(); handleDragMove(e.touches[0].clientX); };
                
                const handleDragEnd = () => {
                    if (!isDragging) return; isDragging = false;
                    document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', handleDragEnd); document.removeEventListener('touchmove', onTouchMove); document.removeEventListener('touchend', handleDragEnd);
                    const max = swipeContainer.offsetWidth - handle.offsetWidth - 12;
                    if (currentX > max * 0.8) {
                        const amount = parseFloat(document.getElementById('payment-amount').value); const accountNumber = document.getElementById('account-number').value.trim(); const currentBalance = currentUserData.wallet?.live || 0;
                        if (isNaN(amount) || !accountNumber || amount > currentBalance || amount < MIN_WITHDRAW || amount > MAX_WITHDRAW) { showModal('error', 'Invalid Input', `Ensure amount is within ${MIN_WITHDRAW}-${MAX_WITHDRAW}, you have sufficient balance, and an account number is provided.`); resetSwipe(); return; }
                        currentPaymentData.amount = amount; currentPaymentData.accountNumber = accountNumber; submitWithdrawRequest();
                    } else { resetSwipe(); }
                };
                const handleDragStart = (clientX) => { isDragging = true; startX = clientX; currentX = 0; document.addEventListener('mousemove', onMouseMove); document.addEventListener('mouseup', handleDragEnd); document.addEventListener('touchmove', onTouchMove, { passive: false }); document.addEventListener('touchend', handleDragEnd); };
                
                handle.addEventListener('mousedown', (e) => handleDragStart(e.clientX));
                handle.addEventListener('touchstart', (e) => handleDragStart(e.touches[0].clientX), { passive: false });
            }
            
            async function submitDepositRequest() {
                const { method, amount, trxId } = currentPaymentData;
                const depositId = database.ref('deposits').push().key;
                await database.ref('deposits/' + depositId).set({ id: depositId, userId: auth.currentUser.uid, userName: currentUserData.name, method, amount, trxId, timestamp: new Date().toISOString(), status: 'pending' });
                screens.payment.classList.add('hidden');
                showCustomModal({ type: 'success', title: 'Request Sent', message: 'Your deposit request is under review. Funds will be added upon approval.', primaryButton: { text: 'OK' } });
            }
            async function submitWithdrawRequest() {
                const { method, amount, accountNumber } = currentPaymentData;
                await database.ref(`users/${auth.currentUser.uid}/wallet/live`).set((currentUserData.wallet?.live || 0) - amount);
                const withdrawId = database.ref('withdrawals').push().key;
                await database.ref('withdrawals/' + withdrawId).set({ id: withdrawId, userId: auth.currentUser.uid, userName: currentUserData.name, method, amount, accountNumber, timestamp: new Date().toISOString(), status: 'pending' });
                screens.payment.classList.add('hidden');
                showCustomModal({ type: 'success', title: 'Request Sent', message: 'Your withdrawal request has been submitted and will be processed within 24 hours.', primaryButton: { text: 'OK' } });
            }

            // --- Account Settings Logic ---
            document.getElementById('change-name-form').addEventListener('submit', e => {
                e.preventDefault();
                const newName = document.getElementById('new-display-name').value.trim();
                if (!newName) return;

                const lastChanged = currentUserData.nameLastChanged || 0;
                const threeDays = 30 * 24 * 60 * 60 * 1000;
                const now = Date.now();

                if (now - lastChanged < threeDays) {
                    const timeLeft = threeDays - (now - lastChanged);
                    const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    showModal('error', 'Please Wait', `You can change your name again in approximately ${days} days and ${hours} hours.`);
                    return;
                }

                handleFormSubmit(e.target, 'Saving name...', async () => {
                    const user = auth.currentUser;
                    await user.updateProfile({ displayName: newName });
                    const updates = {
                        [`/users/${user.uid}/name`]: newName,
                        [`/users/${user.uid}/nameLastChanged`]: now
                    };
                    await database.ref().update(updates);
                    showModal('success', 'Name Updated', `Your display name has been changed to ${newName}.`);
                });
            });

            document.getElementById('change-password-form').addEventListener('submit', e => {
                e.preventDefault();
                const form = e.target;
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-new-password').value;

                if (newPassword !== confirmPassword) {
                    showModal('error', 'Password Mismatch', 'The new passwords do not match.');
                    return;
                }
                if (newPassword.length < 6) {
                    showModal('error', 'Weak Password', 'Password should be at least 6 characters long.');
                    return;
                }

                handleFormSubmit(form, 'Updating password...', async () => {
                    const user = auth.currentUser;
                    const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
                    
                    try {
                        await user.reauthenticateWithCredential(credential);
                        await user.updatePassword(newPassword);
                        form.reset();
                        showModal('success', 'Password Updated', 'Your password has been changed successfully.');
                    } catch (error) {
                        let message = 'An error occurred.';
                        if (error.code === 'auth/wrong-password') {
                            message = 'The current password you entered is incorrect.';
                        } else if (error.code === 'auth/weak-password') {
                            message = 'The new password is too weak.';
                        }
                        throw new Error(message);
                    }
                });
            });

            document.getElementById('delete-account-btn').addEventListener('click', () => {
                showCustomModal({
                    type: 'error',
                    title: 'Delete Account?',
                    message: `<p class="mb-4">This is a permanent action and cannot be undone. All your data, including posts and wallet balance, will be lost. Please enter your current password to confirm.</p>
                              <input type="password" id="delete-confirm-password" placeholder="Enter your password" class="form-input" autocomplete="current-password">`,
                    primaryButton: { text: 'Delete My Account', noClose: true, onClick: async () => {
                        const password = document.getElementById('delete-confirm-password').value;
                        if (!password) {
                            showModal('error', 'Password Required', 'You must enter your password to delete your account.');
                            return;
                        }
                        showLoader('Deleting Account...');
                        try {
                            const user = auth.currentUser;
                            const credential = firebase.auth.EmailAuthProvider.credential(user.email, password);
                            await user.reauthenticateWithCredential(credential);
                            await database.ref(`users/${user.uid}/status`).set('deleted');
                            await user.delete();
                            // User is signed out automatically. onAuthStateChanged handles redirect.
                        } catch (error) {
                            hideLoader();
                            const message = error.code === 'auth/wrong-password' ? 'Incorrect password. Account not deleted.' : 'An error occurred during re-authentication.';
                            showModal('error', 'Deletion Failed', message);
                        }
                    }},
                    secondaryButton: { text: 'Cancel' }
                });
            });

            function handleKickTeam(postId, userId) {
                const post = window.dbData.posts[postId];
                const user = window.dbData.users[userId];
                if (!post || !user || post.status !== 'upcoming') return;

                showCustomModal({
                    type: 'error',
                    title: 'Confirm Kick',
                    message: `Are you sure you want to kick "${user.team?.name || user.name}"? Their slot will become available and their entry fee of ${post.entryFee} TK will be refunded from your event balance.`,
                    primaryButton: {
                        text: 'Yes, Kick Team',
                        onClick: async () => {
                            try {
                                const updates = {};
                                const participantKey = Object.keys(post.participants || {}).find(key => post.participants[key].userId === userId);
                                if (!participantKey) throw new Error("Participant not found.");

                                // Remove participant and free up slot
                                updates[`/posts/${postId}/participants/${participantKey}`] = null;
                                updates[`/posts/${postId}/slots/booked`] = firebase.database.ServerValue.increment(-1);

                                // Refund user and deduct from sponsor
                                if (post.entryFee > 0) {
                                    updates[`/users/${userId}/wallet/live`] = firebase.database.ServerValue.increment(post.entryFee);
                                    updates[`/users/${auth.currentUser.uid}/wallet/event`] = firebase.database.ServerValue.increment(-post.entryFee);
                                }
                                
                                // Send mail to user
                                const mailId = Date.now();
                                updates[`/users/${userId}/mailbox/${mailId}`] = {
                                    id: mailId, postId: parseInt(postId), type: 'kick', read: false,
                                    subject: 'Kicked from a Match',
                                    body: { reason: `You have been kicked from the match "${post.details.eventName}" by the organizer. Your entry fee has been refunded.`, refunded: post.entryFee > 0 },
                                    timestamp: new Date().toISOString()
                                };

                                await database.ref().update(updates);
                                showModal('success', 'Team Kicked', 'The team has been removed and their fee refunded.');
                                if (!screens.participants.classList.contains('hidden')) {
                                    showParticipantList(postId); // Refresh list
                                }
                            } catch (err) {
                                handleFirebaseError(err);
                            }
                        }
                    },
                    secondaryButton: { text: 'Cancel' }
                });
            }

        });
    </script>
</body>
</html>
